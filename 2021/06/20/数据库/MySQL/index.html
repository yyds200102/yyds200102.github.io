<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MySQL | Notes</title><meta name="keywords" content="MySQL数据库"><meta name="author" content="Bug"><meta name="copyright" content="Bug"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MySQL数据库的使用和进阶">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL">
<meta property="og:url" content="http://example.com/2021/06/20/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/index.html">
<meta property="og:site_name" content="Notes">
<meta property="og:description" content="MySQL数据库的使用和进阶">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg">
<meta property="article:published_time" content="2021-06-20T02:53:05.000Z">
<meta property="article:modified_time" content="2021-06-21T02:53:05.000Z">
<meta property="article:author" content="Bug">
<meta property="article:tag" content="MySQL数据库">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2021/06/20/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Bug","link":"链接: ","source":"来源: Notes","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-06-21 10:53:05'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover/17.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Notes</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySQL</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-06-20T02:53:05.000Z" title="发表于 2021-06-20 10:53:05">2021-06-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-06-21T02:53:05.000Z" title="更新于 2021-06-21 10:53:05">2021-06-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">19.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>75分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1、数据库基本概念"><a href="#1、数据库基本概念" class="headerlink" title="1、数据库基本概念"></a>1、数据库基本概念</h1><h2 id="1-1、数据库基本概念"><a href="#1-1、数据库基本概念" class="headerlink" title="1.1、数据库基本概念"></a>1.1、数据库基本概念</h2><ul>
<li><p><strong>数据库</strong>（DB，DataBase）：相关互联的数据集合</p>
</li>
<li><p><strong>数据库管理系统</strong>（DBMS）：数据库系统核心部分，位于用户和os之间</p>
</li>
<li><p><strong>数据库系统</strong>（DBS）：由DB、DBMS、应用系统、DBA（数据库管理员）组成</p>
</li>
<li><p><strong>数据库应用系统</strong>（DBAS）：实现业务逻辑的应用程序</p>
</li>
</ul>
<h2 id="1-2、数据库分类"><a href="#1-2、数据库分类" class="headerlink" title="1.2、数据库分类"></a>1.2、数据库分类</h2><p><strong>关系型数据库</strong>：(SQL)</p>
<ul>
<li>代表：MySQL、Oracle、SQL Server</li>
<li>通过表和表、行和列之间的关系进行数据库的存储</li>
</ul>
<p> <strong>非关系型数据库</strong>：(NoSQL) Not Only</p>
<ul>
<li><p>代表：Redis、MongDB</p>
</li>
<li><p>特点：对象存储</p>
</li>
</ul>
<h2 id="1-3、数据模型"><a href="#1-3、数据模型" class="headerlink" title="1.3、数据模型"></a>1.3、数据模型</h2><blockquote>
<p><strong>根据抽象级别定义4种模型</strong></p>
</blockquote>
<ul>
<li><p><strong>概念模型：</strong>从用户角度描述数据库整体结构，现在常用E-R图表示</p>
<p>实体间联系：1对1、1对多、多对多</p>
</li>
<li><p><strong>逻辑模型：</strong>表达数据库逻辑结构，包括层次模型、网状模型、关系模型</p>
</li>
<li><p><strong>外部模型：</strong>逻辑模型的一个逻辑子集，根据业务特点设计</p>
</li>
<li><p><strong>内部模型：</strong>又称物理模型，描述在磁盘的存储方式</p>
</li>
</ul>
<blockquote>
<p><strong>关系模型</strong></p>
</blockquote>
<p><strong>概念：</strong>包括 数据结构、数据操作、数据的完整性约束</p>
<ul>
<li>关系型数据模型的数据结构<ul>
<li>关系：一个关系就是<strong>一张规范的二维表</strong>，表中的每一列<strong>不可再分</strong>（不能有表中表）</li>
<li>元组：表中的一行</li>
<li>主键：能唯一识别元组的最小属性集合，<strong>只能有一个</strong></li>
<li>候选键：可以有多个，和主键一样非空唯一</li>
<li>属性：表中的一列即为一个属性，每个属性有一个属性名</li>
<li>域：列（属性）的取值范围</li>
<li>关系模式：关系名即表名（属性1，属性2……，属性n）</li>
</ul>
</li>
<li>关系数据库模型的操作：增删改查</li>
<li>完整性约束<ul>
<li>实体完整性：主键不能为null</li>
<li>参照完整性：外键为空或为被参照关系中主键的某个值</li>
<li>用户定义完整性</li>
</ul>
</li>
</ul>
<h2 id="1-4、数据库体系结构"><a href="#1-4、数据库体系结构" class="headerlink" title="1.4、数据库体系结构"></a>1.4、数据库体系结构</h2><ul>
<li>外模式（子模式、用户模式）：又称用户<strong>视图</strong>，用户能直接看到，可以有多个</li>
<li>概念模式（模式、逻辑模式）：数据库全体数据的逻辑结构和特征的描述，只能有一个</li>
<li>内模式（存储、物理模式）：物理结构和存储方式的描述，只能有一个</li>
</ul>
<p><strong>数据独立性</strong>：</p>
<ul>
<li>物理独立性：内模式—–概念模式实现，程序和数据的独立</li>
<li>逻辑独立性：外模式—–概念模式实现，程序和逻辑的独立</li>
</ul>
<h2 id="1-5、SQL语言组成"><a href="#1-5、SQL语言组成" class="headerlink" title="1.5、SQL语言组成"></a>1.5、SQL语言组成</h2><ul>
<li><strong>数据定义语言DDL：</strong>数据定义语句，定义、修改、删除数据库中的对象<ul>
<li>包括CREATE、ALTER、DROP、RENAME以及删除TRUNCATE</li>
</ul>
</li>
<li><strong>数据操纵语言DML：</strong>数据操纵语句，增删改查</li>
<li><strong>数据控制语言DCL：</strong>数据控制语句，定义用户的访问权限和安全级别<ul>
<li>事务：ROLLBACK、COMMIT、SAVEPOINT</li>
<li>权限管理：GRANT、REMOVE</li>
<li>锁定数据库表实现并发控制：LOCKTABLE</li>
</ul>
</li>
</ul>
<blockquote>
<p>DCL</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span>      <span class="comment">-- 授予访问权限</span></span><br><span class="line"><span class="keyword">REVOKE</span>     <span class="comment">-- 撤销访问权限</span></span><br><span class="line"><span class="keyword">COMMIT</span>     <span class="comment">-- 提交事务处理</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>   <span class="comment">-- 事务处理回退</span></span><br><span class="line"><span class="keyword">SAVEPOINT</span>  <span class="comment">-- 设置保存点</span></span><br><span class="line">LOCK       <span class="comment">-- 对数据库的特定部分进行锁定</span></span><br></pre></td></tr></table></figure>

<h1 id="2、MySQL的安装"><a href="#2、MySQL的安装" class="headerlink" title="2、MySQL的安装"></a>2、MySQL的安装</h1><h2 id="2-1、环境安装"><a href="#2-1、环境安装" class="headerlink" title="2.1、环境安装"></a>2.1、环境安装</h2><blockquote>
<p>Windows环境</p>
</blockquote>
<ol>
<li><p>配置环境变量：下载安装包解压</p>
</li>
<li><p>创建my.ini文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">basedir=D:\mysql-5.7.33\</span><br><span class="line">datadir=D:\mysql-5.7.33\data\</span><br><span class="line">port=3306</span><br><span class="line">skip-grant-tables</span><br></pre></td></tr></table></figure></li>
<li><p>管理员运行DOC窗口转到bin目录下</p>
</li>
<li><p>输入mysqld -install安装</p>
</li>
<li><p>输入mysqld –initialize-insecure –console</p>
</li>
<li><p>输入net start mysql启动mysql</p>
</li>
<li><p>输入mysql -uroot -p     进入mysql</p>
</li>
<li><p>输入update mysql.user set authentication_string=password(‘123456’) where user=’root’and Host=’localhost’;       修改密码</p>
</li>
<li><p>输入flush privileges; 刷新权限</p>
</li>
<li><p>net stop mysql</p>
</li>
<li><p>net start mysql</p>
</li>
</ol>
<p><strong>Sqlyog创建数据库：</strong>选utf-8和utf8_general_ci   创建表：引擎选InnoDB</p>
<blockquote>
<p>Linux环境：使用docker</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看Linux服务器上是否安装过MySQL</span></span><br><span class="line">rpm -qa | grep -i mysql # 查询出所有mysql依赖包</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1、拉取镜像</span></span><br><span class="line">docker pull mysql:5.7</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、创建实例并启动</span></span><br><span class="line">docker run -p 3306:3306 --name mysql \</span><br><span class="line">-v /root/mysql/log:/var/log/mysql \</span><br><span class="line">-v /root/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /root/mysql/conf:/etc/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=333 \</span><br><span class="line">-d mysql:5.7</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3、mysql配置 /root/mysql/conf/my.conf</span></span><br><span class="line">[client]</span><br><span class="line"><span class="meta">#</span><span class="bash">mysqlde utf8字符集默认为3位的，不支持emoji表情及部分不常见的汉字，故推荐使用utf8mb4</span></span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash">设置client连接mysql时的字符集,防止乱码</span></span><br><span class="line">init_connect=&#x27;SET collation_connection = utf8_general_ci&#x27;</span><br><span class="line">init_connect=&#x27;SET NAMES utf8&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">数据库默认字符集</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">数据库字符集对应一些排序等规则，注意要和character-set-server对应</span></span><br><span class="line">collation-server=utf8_general_ci</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 跳过mysql程序起动时的字符参数设置 ，使用服务器端字符集设置</span></span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁止MySQL对外部连接进行DNS解析，使用这一选项可以消除MySQL进行DNS解析的时间。但需要注意，如果开启该选项，则所有远程主机连接授权都要使用IP地址方式，否则MySQL将无法正常处理连接请求！</span></span><br><span class="line">skip-name-resolve</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4、重启mysql容器</span></span><br><span class="line">docker restart mysql</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5、进入到mysql容器</span></span><br><span class="line">docker exec -it mysql /bin/bash</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6、查看修改的配置文件</span></span><br><span class="line">cat /etc/mysql/my.conf</span><br></pre></td></tr></table></figure>

<p><strong>安装位置：</strong></p>
<p><code>Docker</code>容器就是一个小型的<code>Linux</code>环境，进入到<code>MySQL</code>容器中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it mysql /bin/bash</span><br></pre></td></tr></table></figure>

<p><code>Linux</code>环境下<code>MySQL</code>的安装目录。</p>
<table>
<thead>
<tr>
<th>路径</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>/var/lib/mysql</code></td>
<td>MySQL数据库文件存放位置</td>
</tr>
<tr>
<td><code>/usr/share/mysql</code></td>
<td>错误消息和字符集文件配置</td>
</tr>
<tr>
<td><code>/usr/bin</code></td>
<td>客户端程序和脚本</td>
</tr>
<tr>
<td><code>/etc/init.d/mysql</code></td>
<td>启停脚本相关</td>
</tr>
</tbody></table>
<h2 id="2-2、修改字符集"><a href="#2-2、修改字符集" class="headerlink" title="2.2、修改字符集"></a>2.2、修改字符集</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、进入到mysql数据库并查看字符集</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> show variables like <span class="string">&#x27;character%&#x27;</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> show variables like <span class="string">&#x27;%char%&#x27;</span>;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">&#x27;character%&#x27;</span>;</span></span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">&#x27;%char%&#x27;</span>;</span></span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>



<p><code>MySQL5.7</code>配置文件位置是<code>/etc/my.cnf</code>或者<code>/etc/mysql/my.cnf</code>，如果字符集不是<code>utf-8</code>直接进入配置文件修改即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置client连接mysql时的字符集,防止乱码</span></span><br><span class="line">init_connect=&#x27;SET NAMES utf8&#x27;</span><br><span class="line">init_connect=&#x27;SET collation_connection = utf8_general_ci&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据库默认字符集</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">数据库字符集对应一些排序等规则，注意要和character-set-server对应</span></span><br><span class="line">collation-server=utf8_general_ci</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 跳过mysql程序起动时的字符参数设置 ，使用服务器端字符集设置</span></span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁止MySQL对外部连接进行DNS解析，使用这一选项可以消除MySQL进行DNS解析的时间。但需要注意，如果开启该选项，则所有远程主机连接授权都要使用IP地址方式，否则MySQL将无法正常处理连接请求！</span></span><br><span class="line">skip-name-resolve</span><br></pre></td></tr></table></figure>

<p><strong>注意：安装<code>MySQL</code>完毕之后，第一件事就是修改字符集编码。</strong></p>
<h2 id="2-3、配置文件"><a href="#2-3、配置文件" class="headerlink" title="2.3、配置文件"></a>2.3、配置文件</h2><p><strong><code>MySQL</code>配置文件讲解：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/gaoyuechen/p/10273102.html">https://www.cnblogs.com/gaoyuechen/p/10273102.html</a></strong></p>
<p>1、二进制日志<code>log-bin</code>：主从复制。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> my,cnf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启mysql binlog功能</span></span><br><span class="line">log-bin=mysql-bin</span><br></pre></td></tr></table></figure>

<p>2、错误日志<code>log-error</code>：默认是关闭的，记录严重的警告和错误信息，每次启动和关闭的详细信息等。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> my,cnf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据库错误日志文件</span></span><br><span class="line">log-error = error.log</span><br></pre></td></tr></table></figure>

<p>3、查询日志<code>log</code>：默认关闭，记录查询的<code>sql</code>语句，如果开启会降低<code>MySQL</code>整体的性能，因为记录日志需要消耗系统资源。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> my,cnf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 慢查询sql日志设置</span></span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = slow.log</span><br></pre></td></tr></table></figure>

<p>4、数据文件。</p>
<ul>
<li><code>frm文件</code>：存放表结构。</li>
<li><code>myd</code>文件：存放表数据。</li>
<li><code>myi</code>文件：存放表索引。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mysql5.7 使用.frm文件来存储表结构</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 .ibd文件来存储表索引和表数据</span></span><br><span class="line">-rw-r-----  1 mysql mysql   8988 Jun 25 09:31 pms_category.frm</span><br><span class="line">-rw-r-----  1 mysql mysql 245760 Jul 21 10:01 pms_category.ibd</span><br></pre></td></tr></table></figure>

<p><code>MySQL5.7</code>的<code>Innodb</code>存储引擎可将所有数据存放于<code>ibdata*</code>的共享表空间，也可将每张表存放于独立的<code>.ibd</code>文件的独立表空间。<br>共享表空间以及独立表空间都是针对数据的存储方式而言的。</p>
<ul>
<li>共享表空间: 某一个数据库的所有的表数据，索引文件全部放在一个文件中，默认这个共享表空间的文件路径在<code>data</code>目录下。 默认的文件名为<code>:ibdata1</code> 初始化为<code>10M</code>。</li>
<li>独立表空间: 每一个表都将会生成以独立的文件方式来进行存储，每一个表都有一个<code>.frm</code>表描述文件，还有一个<code>.ibd</code>文件。 其中这个文件包括了单独一个表的数据内容以及索引内容，默认情况下它的存储位置也是在表的位置之中。在配置文件<code>my.cnf</code>中设置： <code>innodb_file_per_table</code>。</li>
</ul>
<h1 id="3、MySQL的基本概念"><a href="#3、MySQL的基本概念" class="headerlink" title="3、MySQL的基本概念"></a>3、MySQL的基本概念</h1><h2 id="3-1、MySQL逻辑架构"><a href="#3-1、MySQL逻辑架构" class="headerlink" title="3.1、MySQL逻辑架构"></a>3.1、MySQL逻辑架构</h2><p><img src="/img/MySQL/1.jpg"></p>
<ul>
<li><p><code>Connectors</code>：指的是不同语言中与SQL的交互。</p>
</li>
<li><p><code>Connection Pool</code>：管理缓冲用户连接，线程处理等需要缓存的需求。<strong>MySQL数据库的连接层。</strong></p>
</li>
<li><p><code> Management Serveices &amp; Utilities</code>：系统管理和控制工具。备份、安全、复制、集群等等。。</p>
</li>
<li><p><code>SQL Interface</code>：接受用户的SQL命令，并且返回用户需要查询的结果。</p>
</li>
<li><p><code>Parser</code>：SQL语句解析器。</p>
</li>
<li><p><code>Optimizer</code>：查询优化器，SQL语句在查询之前会使用查询优化器对查询进行优化。<strong>就是优化客户端请求query</strong>，根据客户端请求的 query 语句，和数据库中的一些统计信息，在一系列算法的基础上进行分析，得出一个最优的策略，告诉后面的程序如何取得这个 query 语句的结果。<strong>For Example</strong>： <code>select uid,name from user where gender = 1;</code>这个<code>select </code>查询先根据<code>where </code>语句进行选取，而不是先将表全部查询出来以后再进行<code>gender</code>过滤；然后根据<code>uid</code>和<code>name</code>进行属性投影，而不是将属性全部取出以后再进行过滤。最后将这两个查询条件联接起来生成最终查询结果。</p>
</li>
<li><p><code>Caches &amp; Buffers</code>：查询缓存。</p>
</li>
<li><p><code>Pluggable Storage Engines</code>：<strong>存储引擎接口。MySQL区别于其他数据库的最重要的特点就是其插件式的表存储引擎(注意：存储引擎是基于表的，而不是数据库)。</strong></p>
</li>
<li><p><code>File System</code>：数据落地到磁盘上，就是文件的存储。</p>
</li>
</ul>
<p>MySQL数据库和其他数据库相比，MySQL有点与众不同，主要体现在存储引擎的架构上，<strong>插件式的存储引擎架构将查询处理和其他的系统任务以及数据的存储提取相分离</strong>。这种架构可以根据业务的需求和实际需求选择合适的存储引擎。</p>
<blockquote>
<p>逻辑架构分层</p>
</blockquote>
<p><img src="/img/MySQL/2.jpg"></p>
<ul>
<li><p>连接层：最上层是一些客户端和连接服务，包含本地sock通信和大多数基于客户端/服务端工具实现的类似于<code>tcp/ip</code>的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于<code>SSL</code>的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。</p>
</li>
<li><p>服务层：MySQL的核心服务功能层，该层是MySQL的核心，包括查询缓存，解析器，解析树，预处理器，查询优化器。主要进行查询解析、分析、查询缓存、内置函数、存储过程、触发器、视图等，select操作会先检查是否命中查询缓存，命中则直接返回缓存数据，否则解析查询并创建对应的解析树。</p>
</li>
<li><p>引擎层：存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取。</p>
</li>
<li><p>存储层：数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互。</p>
</li>
</ul>
<h2 id="3-2、MySQL的引擎"><a href="#3-2、MySQL的引擎" class="headerlink" title="3.2、MySQL的引擎"></a>3.2、MySQL的引擎</h2><p><code>show engines;</code>命令查看MySQL5.7支持的存储引擎。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show engines;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20200801170442428.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="存储引擎"></p>
<p><code>show variables like &#39;default_storage_engine%&#39;;</code>查看当前数据库正在使用的存储引擎。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">&#x27;default_storage_engine%&#x27;</span>;</span></span><br><span class="line">+------------------------+--------+</span><br><span class="line">| Variable_name          | Value  |</span><br><span class="line">+------------------------+--------+</span><br><span class="line">| default_storage_engine | InnoDB |</span><br><span class="line">+------------------------+--------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>InnoDB和MyISAM对比</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>MYISAM</th>
<th>INNODB</th>
</tr>
</thead>
<tbody><tr>
<td>事务支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>数据行锁定</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>数据表锁定</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>外键约束</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>全文索引</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>表空间大小</td>
<td>较小</td>
<td>较大，约为2倍</td>
</tr>
</tbody></table>
<ul>
<li>MYISAM：节约空间，速度较快，<code>每次查询具有原子性</code>，不支持事务。</li>
<li>INNODB：安全性高，支持事务处理，回滚，<code>崩溃修复能力</code>，事务安全ACID。支持MVCC应对⾼并发事务, 一种多版本并发控制的机制：可以用B+树来支撑实现MVCC。</li>
</ul>
<p><strong>注意：</strong>在很多我们已知场景中，InnoDB的速度都可以让MyISAM望尘莫及，尤其是⽤到了聚簇索引，或者需要访问的数据都可以放⼊内存的应用。</p>
<h2 id="3-3、数据库的字段类型"><a href="#3-3、数据库的字段类型" class="headerlink" title="3.3、数据库的字段类型"></a>3.3、数据库的字段类型</h2><blockquote>
<p>1、整型</p>
</blockquote>
<ul>
<li>tinyint：        很小的数据  1字节</li>
<li>smallint：     较小数据   2字节</li>
<li>mediumint：中等大小   3字节</li>
<li>int：              标准整数   4字节</li>
<li>bigint：         较大的数据  8字节</li>
</ul>
<blockquote>
<p>2、小数</p>
</blockquote>
<ul>
<li>float：           浮点数    4字节</li>
<li>double</li>
<li>decimal          字符串形式浮点数 金融计算的时候一般是使用decaimal</li>
</ul>
<blockquote>
<p>3、字符串</p>
</blockquote>
<ul>
<li>char         字符串固定大小   0~255</li>
<li>varcahr    可变字符串           0~6535</li>
<li>tingtext   微型文本                2^8-1</li>
<li>text          文本串                   2^16-1</li>
</ul>
<blockquote>
<p>4、二进制字符串</p>
</blockquote>
<ul>
<li>binary</li>
<li>varbinary</li>
</ul>
<blockquote>
<p>5、时间日期</p>
</blockquote>
<ul>
<li>date           YYYY-MM-DD         日期</li>
<li>time           HH：mm：ss       时间格式</li>
<li>datatime         日期时间(最常用)</li>
<li>timestamp      时间戳，1970.1.1到现在的毫秒数</li>
<li>year                 年份表示</li>
</ul>
<blockquote>
<p>6、Null</p>
</blockquote>
<ul>
<li>没有值</li>
</ul>
<blockquote>
<p>7、数据库的字段属性</p>
</blockquote>
<ul>
<li>Unsigned： 无符号<strong>整数</strong>，不能为负数</li>
<li>Zerofill：  不足的位数使用0来填充</li>
<li>自增：   自动在上一条记录的基础上+1，必须整数类型，可以设计起始值和步长</li>
<li>非空：   </li>
<li>默认：   默认值</li>
</ul>
<h2 id="3-4、MySQL字符集校验"><a href="#3-4、MySQL字符集校验" class="headerlink" title="3.4、MySQL字符集校验"></a>3.4、MySQL字符集校验</h2><ul>
<li>字符集：指的是⼀种从⼆进制编码到某类字符符号的映射。</li>
<li>校对规则：是指某种字符集下的排序规则。MySQL中每⼀种字符集都会对应⼀系列的校对规则。</li>
<li>MySQL采⽤的是类似继承的方式指定字符集的默认值，每个数据库以及每张数据表都有自己的默认值，他们逐层继承。比如：某个库中所有表的默认字符集将是该数据库所指定的字符集（这些表在没有指定字符集的情况下，才会采用默认字符集） </li>
</ul>
<h3 id="1、字符集"><a href="#1、字符集" class="headerlink" title="1、字符集"></a>1、字符集</h3><p><strong>概念：</strong>是多个字符(英文字符，汉字字符，或者其他国家语言字符)的集合，字符集种类较多，每个字符集包含的字符个数不同。</p>
<ul>
<li>字符编码方式是用一个或多个字节表示字符集中的一个字符</li>
<li>每种字符集都有自己特有的编码方式，因此同一个字符，在不同字符集的编码方式下，会产生不同的二进制</li>
</ul>
<blockquote>
<p>常见的字符集</p>
</blockquote>
<ul>
<li>ASCII字符集：基于罗马字母表的一套字符集，它采用1个字节的低7位表示字符，高位始终为0。</li>
<li>LATIN1字符集：相对于ASCII字符集做了扩展，仍然使用一个字节表示字符，但启用了高位，扩展了字符集的表示范围。</li>
<li>GBK字符集：支持中文，字符有一字节编码和两字节编码方式。</li>
<li>UTF8字符集：Unicode字符集的一种，是计算机科学领域里的一项业界标准，支持了所有国家的文字字符，utf8采用1-4个字节表示字符。</li>
</ul>
<h3 id="2、正确使用MYSQL字符集"><a href="#2、正确使用MYSQL字符集" class="headerlink" title="2、正确使用MYSQL字符集"></a>2、正确使用MYSQL字符集</h3><p><img src="/img%5CMySQL%5C1.png"></p>
<p><img src="/img%5CMySQL%5C2.png"></p>
<blockquote>
<p>1、新增</p>
</blockquote>
<ol>
<li>建库时，若未明确指定字符集，则采用character_set_server指定的字符集。</li>
<li>建表时，若未明确指定字符集，则采用当前库所采用的字符集。</li>
<li>新增时，修改表字段时，若未明确指定字符集，则采用当前表所采用的字符集。</li>
</ol>
<blockquote>
<p>2、更新、查询</p>
</blockquote>
<ul>
<li>更新流程字符集转换过程：character_set_client–&gt;character_set_connection–&gt;表字符集。</li>
<li>查询流程字符集转换过程：表字符集–&gt;character_set_result</li>
</ul>
<blockquote>
<p>3、character_set_database</p>
</blockquote>
<p>　　当前默认数据库的字符集，比如执行use xxx后，当前数据库变为xxx，若xxx的字符集为utf8，那么此变量值就变为utf8(供系统设置，无需人工设置)。</p>
<h3 id="3、MySQL客户端与字符集"><a href="#3、MySQL客户端与字符集" class="headerlink" title="3、MySQL客户端与字符集"></a>3、MySQL客户端与字符集</h3><blockquote>
<p>1、输入</p>
</blockquote>
<p>客户端使用的字符集必须通过character_set_client、character_set_connection体现出来：</p>
<ol>
<li>在客户端对数据进行编码（Linux：utf8、windows：gbk）</li>
<li>MySQL接到SQL语句后(比如insert)，发现有字符，询问客户端通过什么方式对字符编码：客户端通过character_set_client参数告知MySQL客户端的编码方式(所以此参数需要正确反映客户端对应的编码)</li>
<li>当MySQL发现客户端的client所传输的字符集与自己的connection不一样时，会将client的字符集转换为connection的字符集</li>
<li>MySQL将转换后的编码存储到MySQL表的列上，在存储的时候再判断编码是否与内部存储字符集（按照优先级判断字符集类型）上的编码一致，如果不一致需要再次转换</li>
</ol>
<blockquote>
<p>2、查询</p>
</blockquote>
<p>客户端使用的字符集必须通过character_set_results来体现，服务器询问客户端字符集，通过character_set_results将结果转换为与客户端相同的字符集传递给客户端。(character_set_results默认等于character_set_client)</p>
<h3 id="4、常用操作"><a href="#4、常用操作" class="headerlink" title="4、常用操作"></a>4、常用操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1.查看字符集编码设置</span><br><span class="line"></span><br><span class="line">　　mysql&gt; show variables like &#x27;%character%&#x27;;</span><br><span class="line"></span><br><span class="line">2.设置字符集编码</span><br><span class="line"></span><br><span class="line">　　mysql&gt; set names &#x27;utf8&#x27;;</span><br><span class="line"></span><br><span class="line">相当于同时：</span><br><span class="line"></span><br><span class="line">　　set character_set_client = utf8;</span><br><span class="line"></span><br><span class="line">　　set character_set_results = utf8;</span><br><span class="line"></span><br><span class="line">　　set character_set_connection = utf8;</span><br><span class="line"></span><br><span class="line">3.修改数据库字符集</span><br><span class="line"></span><br><span class="line">　　mysql&gt; alter database database_name character set xxx;</span><br><span class="line"></span><br><span class="line">只修改库的字符集，影响后续创建的表的默认定义；对于已创建的表的字符集不受影响。（一般在数据库实现字符集即可，表和列都默认采用数据库的字符集）</span><br><span class="line"></span><br><span class="line">4.修改表的字符集</span><br><span class="line"></span><br><span class="line">　　mysql&gt; alter table table_name character set xxx；</span><br><span class="line"></span><br><span class="line">只修改表的字符集，影响后续该表新增列的默认定义，已有列的字符集不受影响。</span><br><span class="line"></span><br><span class="line">　　mysql&gt; alter table table_name convert to character set xxx;</span><br><span class="line"></span><br><span class="line">同时修改表字符集和已有列字符集，并将已有数据进行字符集编码转换。</span><br><span class="line"></span><br><span class="line">5.修改列字符集</span><br><span class="line"></span><br><span class="line">格式：</span><br><span class="line"></span><br><span class="line">ALTER TABLE table_name MODIFY</span><br><span class="line"></span><br><span class="line">column_name &#123;CHAR | VARCHAR | TEXT&#125; (column_length)</span><br><span class="line"></span><br><span class="line">    [CHARACTER SET charset_name]</span><br><span class="line"></span><br><span class="line">    [COLLATE collation_name]</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table table_name modify col_name varchar(col_length) character set xxx;</span><br></pre></td></tr></table></figure>



<h2 id="3-5、MySQL常用函数"><a href="#3-5、MySQL常用函数" class="headerlink" title="3.5、MySQL常用函数"></a>3.5、MySQL常用函数</h2><h3 id="1、MySQL常量"><a href="#1、MySQL常量" class="headerlink" title="1、MySQL常量"></a>1、MySQL常量</h3><ul>
<li>字符串：         单引号’ ‘ 或双引号”   “</li>
<li>数值：             直接用</li>
<li>日期和时间： 单引号’ ‘ </li>
<li>布尔                 1表示true   0表示false</li>
<li>NULL                NULL参与运算，结果仍为NULL</li>
</ul>
<h3 id="2、常用函数"><a href="#2、常用函数" class="headerlink" title="2、常用函数"></a>2、常用函数</h3><blockquote>
<p>数学运算</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">ABS</span>(<span class="number">-8</span>)            <span class="comment">-- 绝对值</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">CEILING</span>(<span class="number">9.4</span>)       <span class="comment">-- 下上取整</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">FLOOR</span>(<span class="number">9.4</span>)         <span class="comment">-- 向下</span></span><br><span class="line"><span class="keyword">SELECT</span> ROUND(<span class="number">45.926</span>, <span class="number">2</span>)   <span class="comment">-- 四舍五入 45.3</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MOD</span>(<span class="number">1600</span>, <span class="number">300</span>)     <span class="comment">-- 求余数 100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> RAND()             <span class="comment">-- 0~1的绝对值</span></span><br><span class="line"><span class="keyword">SELECT</span> SIGN(<span class="number">10</span>)           <span class="comment">-- 判断符号</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">TRUNCATE</span>(<span class="number">3.14159</span>,<span class="number">2</span>)  <span class="comment">-- 截取前面2位</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>字符串</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">LOWER</span>()                       <span class="comment">-- 小写</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">UPPER</span>()                       <span class="comment">-- 大写</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CHAR_LENGTH</span>()                 <span class="comment">-- 长度</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;我&#x27;</span>,<span class="string">&#x27;是&#x27;</span>)              <span class="comment">-- 拼接字符串</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> SUBSTR(<span class="string">&#x27;HelloWorld&#x27;</span>,<span class="number">1</span>,<span class="number">5</span>)      <span class="comment">-- 截取字符串,第1个开始截取5个字符</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">INSERT</span>(<span class="string">&#x27;我爱学习&#x27;</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="string">&#x27;不&#x27;</span>)    <span class="comment">-- 替换字符串，返回  我不习</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> INSTR(<span class="string">&#x27;wzh&#x27;</span>,<span class="string">&#x27;h&#x27;</span>)              <span class="comment">-- 返回h第一次出现的索引</span></span><br><span class="line"><span class="keyword">SELECT</span> REPLACE(<span class="string">&#x27;坚持学习&#x27;</span>,<span class="string">&#x27;学习&#x27;</span>,<span class="string">&#x27;吃&#x27;</span>) <span class="comment">-- 替换</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>时间和日期</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">CURRENT_DATE</span>()    <span class="comment">-- 当前日期</span></span><br><span class="line"><span class="keyword">SELECT</span> CURDATE()         <span class="comment">-- 当前日期</span></span><br><span class="line"><span class="keyword">SELECT</span> NOW()             <span class="comment">-- 当前时间</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">LOCALTIME</span>()       <span class="comment">-- 本地时间</span></span><br><span class="line"><span class="keyword">SELECT</span> SYSDATE()         <span class="comment">-- 系统时间</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(NOW())       <span class="comment">-- 年份</span></span><br></pre></td></tr></table></figure>

<h3 id="3、聚合函数"><a href="#3、聚合函数" class="headerlink" title="3、聚合函数"></a>3、聚合函数</h3><ul>
<li>COUNT()  计数  //不会忽略null值</li>
<li>SUM()   求和</li>
<li>AVG()   p平均值</li>
<li>MAX()   最大值</li>
<li>MIN()   最小值</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 不能在where中使用，可以在having中使用</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(id) <span class="keyword">FROM</span> student         <span class="comment">-- 会忽略NULL值</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> student          <span class="comment">-- 不会忽略NULL值，本质是计算行数</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="number">1</span>) <span class="keyword">FROM</span> student          <span class="comment">-- 不会忽略NULL值，本质是计算行数</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(age) <span class="keyword">AS</span> 年龄 <span class="keyword">FROM</span> student   <span class="comment">-- 计算总和</span></span><br></pre></td></tr></table></figure>

<h3 id="4、MD5加密"><a href="#4、MD5加密" class="headerlink" title="4、MD5加密"></a>4、MD5加密</h3><p>MD5加密是<strong>不可逆</strong>的过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">插入后加密：</span><br><span class="line">UPDATE student <span class="keyword">SET</span> `pwd` <span class="operator">=</span> MD5(`pwd`) <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">插入时加密：</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `student` (id,`name`,`pwd`,`sex`)<span class="keyword">VALUES</span>(<span class="number">9</span>,<span class="string">&#x27;李三啊&#x27;</span>,MD5(<span class="number">1258</span>),<span class="string">&#x27;男&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>检验：</strong>将用户传递进来的密码，进行MD5加密然后对比加密的值</p>
<h2 id="3-6、SQL性能下降的原因"><a href="#3-6、SQL性能下降的原因" class="headerlink" title="3.6、SQL性能下降的原因"></a>3.6、SQL性能下降的原因</h2><ul>
<li>查询语句写的差。</li>
<li>索引失效：索引建了，但是没有用上。</li>
<li>关联 查询太多<code>join</code>（设计缺陷或者不得已的需求）。</li>
<li>服务器调优以及各个参数的设置（缓冲、线程数等）。</li>
</ul>
<h1 id="4、DDL结构化语句"><a href="#4、DDL结构化语句" class="headerlink" title="4、DDL结构化语句"></a>4、DDL结构化语句</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>   <span class="comment">-- 创建数据库表</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span>    <span class="comment">-- 更改表结构、添加、删除、修改列长度</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span>     <span class="comment">-- 删除表</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX   <span class="comment">-- 在表上建立索引</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX     <span class="comment">-- 删除索引</span></span><br></pre></td></tr></table></figure>

<h2 id="4-1、DDL之创建数据库"><a href="#4-1、DDL之创建数据库" class="headerlink" title="4.1、DDL之创建数据库"></a>4.1、DDL之创建数据库</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Show</span> databases;             <span class="comment">-- 展示所有数据库</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> school <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;   <span class="comment">-- 创建school数据库</span></span><br><span class="line"></span><br><span class="line">USE school;                 <span class="comment">-- 使用school数据库</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE school;       <span class="comment">-- 删除数据库</span></span><br></pre></td></tr></table></figure>

<h2 id="4-2、DDL之创建表"><a href="#4-2、DDL之创建表" class="headerlink" title="4.2、DDL之创建表"></a>4.2、DDL之创建表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `student` (          <span class="comment">-- 创建student表</span></span><br><span class="line">	`id` <span class="type">INT</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,  <span class="comment">-- 自增</span></span><br><span class="line">	`name` <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;张三&#x27;</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">	`pwd` <span class="type">VARCHAR</span>(<span class="number">20</span>),              <span class="comment">-- COMMENT  </span></span><br><span class="line">	`sex` <span class="type">VARCHAR</span>(<span class="number">2</span>),               <span class="comment">-- DEFAULT 默认值</span></span><br><span class="line">	`birthday` DATETIME,            <span class="comment">-- NOT NULL 非空</span></span><br><span class="line">	`addrss` <span class="type">VARCHAR</span>(<span class="number">100</span>),          <span class="comment">-- AUTO_INCREMENT 自增</span></span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY(id),</span><br><span class="line">    INDEX myindex(name,pwd,sex)</span><br><span class="line">)ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;            <span class="comment">-- 设置引擎和编码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> student2 <span class="keyword">as</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student    <span class="comment">-- 子查询创建表</span></span><br><span class="line">USE student;                                      <span class="comment">-- 选择student表</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 扩展</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> DATABASE school    <span class="comment">-- 显示数据库的sql语句</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> student      <span class="comment">-- 显示创建表的sql语句</span></span><br><span class="line"><span class="keyword">DESC</span> student                   <span class="comment">-- 显示表结构</span></span><br><span class="line"><span class="keyword">DESCRIBE</span> student               <span class="comment">-- 显示表结构</span></span><br></pre></td></tr></table></figure>

<h2 id="4-3、DDL之表的修改"><a href="#4-3、DDL之表的修改" class="headerlink" title="4.3、DDL之表的修改"></a>4.3、DDL之表的修改</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 表添加列（字段）</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `student` <span class="keyword">ADD</span> age <span class="type">INT</span>(<span class="number">3</span>)<span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;18&#x27;</span> COMMENT <span class="string">&#x27;年龄&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> studtnet          <span class="comment">-- 删除student表，表结构不在</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> student       <span class="comment">-- 截断student表，表结构仍在</span></span><br><span class="line">                                       <span class="comment">-- 注意截断的表不能回滚，删除的可以</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `student` <span class="keyword">DROP</span> age1        <span class="comment">-- 删除字段</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `student` RENAME <span class="keyword">AS</span> s               <span class="comment">-- 重命名表名 </span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `student` <span class="keyword">to</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `student` CHANGE age age1 <span class="type">INT</span>(<span class="number">2</span>)    <span class="comment">-- 重命名字段名,必须指定类型和大小</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `student` MODIFY age <span class="type">VARCHAR</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;18&#x27;</span> COMMENT <span class="string">&#x27;年龄&#x27;</span> </span><br></pre></td></tr></table></figure>

<h2 id="4-4、数据约束"><a href="#4-4、数据约束" class="headerlink" title="4.4、数据约束"></a>4.4、数据约束</h2><p><strong>注意到：</strong>创建表之后字段后面跟的一大堆就是对字段的约束</p>
<ul>
<li>为了保证数据的一致性和完整性，SQL规范以约束的方式对表数据进行额外的条件限制</li>
<li>约束是表级的强制规定</li>
<li>可以在创建表时规定约束、或者在表创建之后</li>
</ul>
<p><strong>六种约束</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">NOT</span> <span class="keyword">NULL</span>       <span class="comment">-- 非空约束，规定某个字段不能为空</span></span><br><span class="line"><span class="keyword">UNIQUE</span>         <span class="comment">-- 唯一约束，规定某个字段在整个表中是唯一的</span></span><br><span class="line"><span class="keyword">PRIMARY</span> KEY    <span class="comment">-- 主键(非空且唯一) </span></span><br><span class="line"><span class="keyword">FOREIGN</span> KEY    <span class="comment">-- 外键</span></span><br><span class="line"><span class="keyword">CHECK</span>          <span class="comment">-- 检查约束  -- 可以使用但是mysql没有效果</span></span><br><span class="line"><span class="keyword">DEFAULT</span>        <span class="comment">-- 默认值</span></span><br></pre></td></tr></table></figure>

<p><strong>分类：</strong></p>
<ul>
<li>列级：只能约束单个字段</li>
<li>表级：可以约束多个字段</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- not null 非空约束</span></span><br><span class="line">id <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>                                <span class="comment">-- 建表时添加</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp MODIFY sex <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>;   <span class="comment">-- 增加约束</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp MODIFY sex <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NULL</span>;       <span class="comment">-- 取消约束</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- UNIQUE 唯一约束默认创建唯一索引，注意不同字段直接可以重复</span></span><br><span class="line">NAME <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">UNIQUE</span>;</span><br><span class="line"><span class="keyword">CONSTRAINT</span> uk_name_pwd <span class="keyword">UNIQUE</span>(NAME)                 <span class="comment">-- 建表时添加，用户名不能重复</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span>(NAME,PASSWORD);         <span class="comment">-- 增加约束</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> uk_name_pwd <span class="keyword">UNIQUE</span>(NAME,PASSWORD);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> MODIFY NAME <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">UNIQUE</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">DROP</span> INDEX uk_name_pwd;   <span class="comment">-- 删除约束,没自定义名字的话为字段名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 主键约束 一个表只能有一个</span></span><br><span class="line">`id` <span class="type">INT</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT        <span class="comment">-- 建表时添加主键</span></span><br><span class="line"><span class="keyword">CONSTRAINT</span> id <span class="keyword">PRIMARY</span> KEY(id,name)         <span class="comment">-- 表级才能定义多个子弹和定义别名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">DROP</span> <span class="keyword">PRIMARY</span> KEY;               <span class="comment">-- 删除约束</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">ADD</span> <span class="keyword">PRIMARY</span> KEY(name,pwd);      <span class="comment">-- 添加约束，已存在就不能添加</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> MODIFY id <span class="type">INT</span>(<span class="number">2</span>) <span class="keyword">PRIMARY</span> KEY;   <span class="comment">-- 修改约束，已存在就不能修改</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 外键约束 FOREIGN KEY </span></span><br><span class="line"><span class="keyword">FOREIGN</span> KEY (`gradeid`) REFERNECES `grade`(`id`)   <span class="comment">-- 关联年级表(grade)的id字段</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `student` <span class="keyword">ADD</span> 加上                      <span class="comment">-- 添加外键</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">DROP</span> <span class="keyword">FOREIGN</span> KEY emp_dept_id_fk;   <span class="comment">-- 删除外键</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- not null  default</span></span><br><span class="line">id <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">20</span>;                    <span class="comment">-- 建表时添加</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp MODIFY sex <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>;   <span class="comment">-- MODIFY修改字段</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 主键 PRIMARY KEY、唯一约束 UNIQUE</span></span><br><span class="line">id <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">UNIQUE</span><span class="operator">/</span><span class="keyword">PRIMARY</span>;     <span class="comment">-- 建表时列级范围添加</span></span><br><span class="line"><span class="keyword">PRIMARY</span> KEY<span class="operator">/</span><span class="keyword">UNIQUE</span>(name,pwd);  <span class="comment">-- 建表时标记范围添加  取别名 CONSTRAINT 名字 </span></span><br><span class="line"><span class="keyword">FOREIGN</span> KEY (`gradeid`) REFERNECES `grade`(`id`)   <span class="comment">-- 外键关联年级表(grade)的id字段</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">ADD</span> 形式<span class="number">2</span><span class="operator">/</span><span class="number">3</span>;             <span class="comment">-- ADD添加约束</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">DROP</span> INDEX 约束名称;      <span class="comment">-- DROP删除约束</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">DROP</span> <span class="keyword">PRIMARY</span> KEY;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">DROP</span> <span class="keyword">FOREIGN</span> KEY 约束名称;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Modifty 不建议使用</span></span><br></pre></td></tr></table></figure>

<h2 id="4-5、索引入门"><a href="#4-5、索引入门" class="headerlink" title="4.5、索引入门"></a>4.5、索引入门</h2><h3 id="1、索引的定义"><a href="#1、索引的定义" class="headerlink" title="1、索引的定义"></a>1、索引的定义</h3><p><strong>官方定义：</strong>索引（INDEX）是帮助MySQL高效获取数据的数据结果。</p>
<p><strong>索引的本质：</strong>索引是排好序的快速查找数据结构。</p>
<p><strong>举例：</strong>索引的目的在于提高查询效率，可以类比字典的目录。如果要查<code>mysql</code>这个这个单词，我们肯定要先定位到<code>m</code>字母，然后从上往下找<code>y</code>字母，再找剩下的<code>sql</code>。如果没有索引，那么可能需要<code>a---z</code>，这样全字典扫描，如果我想找<code>Java</code>开头的单词呢？如果我想找<code>Oracle</code>开头的单词呢？？？</p>
<p><strong>重点：</strong>索引会影响到<code>MySQL查找(WHERE的查询条件)和排序(ORDER BY)</code>两大功能！</p>
<p><strong>结构：</strong>数据库维护着一个满足特定查找算法的<code>数据结构</code>，这些数据结构以某种方式指向数据，这样就可以在这些数据结构的基础上实现高级查找算法，这种数据结构就是索引。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们平时所说的索引，如果没有特别指明，都是指B树（多路搜索树，并不一定是二叉的）结构组织的索引。其中聚集索引，次要索引，覆盖索引，复合索引，前缀索引，唯一索引默认都是使用B+树索引，统称索引。当然，除了B+树这种数据结构的索引之外，还有哈希索引（Hash Index）等。</span><br></pre></td></tr></table></figure>

<p><strong>位置：</strong>索引往往以索引文件的形式存储在磁盘上。</p>
<h3 id="2、索引的优劣"><a href="#2、索引的优劣" class="headerlink" title="2、索引的优劣"></a>2、索引的优劣</h3><p><strong>优势：</strong></p>
<ul>
<li>查找：类似大学图书馆的书目索引，提高数据检索的效率，降低数据库的IO成本。</li>
<li>排序：通过索引対数据进行排序，降低数据排序的成本，降低了CPU的消耗。</li>
</ul>
<p><strong>劣势：</strong></p>
<ul>
<li>实际上索引<code>也是一张表</code>，该表保存了主键与索引字段，并指向实体表的记录，也要占用空间的。</li>
<li>虽然索引大大提高了查询速度，但是同时会<strong>降低表的更新速度</strong>，因为表更新，索引也得更新。索引文件每次更新添加的索引列的字段，都会调整因为更新所带来的键值变化后的索引信息。</li>
</ul>
<h3 id="3、索引的分类"><a href="#3、索引的分类" class="headerlink" title="3、索引的分类"></a>3、索引的分类</h3><blockquote>
<p>根据索引的类型</p>
</blockquote>
<ul>
<li><strong>主键索引 PRIMARY KEY</strong>： 自动创建，主键不可重复，只能有一个列作为主键</li>
<li><strong>唯一索引 UNIQUE KEY：</strong>可以有多个，索引列本列的值是唯一的，为可以空</li>
<li><strong>外键索引 FOREIGN KEY：</strong>MySQL会自动添加索引</li>
<li><strong>普通索引 KEY/INDEX ：</strong></li>
<li><strong>全文索引FULLTEXT ：</strong>特定的数据库引擎（MYISAM）才有</li>
</ul>
<blockquote>
<p>根据索引的列多少</p>
</blockquote>
<ul>
<li><strong>单值索引：</strong>一个索引只包含单个列，一个表可以有多个单列索引。</li>
<li><strong>复合索引：</strong>一个索引包含多个字段。</li>
</ul>
<blockquote>
<p>按照数据结构分类</p>
</blockquote>
<ul>
<li><code>BTree</code>索引。</li>
<li><code>Hash</code>索引。</li>
<li><code>Full-text</code>全文索引。</li>
<li><code>R-Tree</code>索引。</li>
</ul>
<p>B树索引的原理：</p>
<p><img src="/img/MySQL/4.jpg"></p>
<h3 id="4、约束和索引的区别"><a href="#4、约束和索引的区别" class="headerlink" title="4、约束和索引的区别"></a>4、约束和索引的区别</h3><blockquote>
<p>唯一约束和唯一索引</p>
</blockquote>
<ul>
<li>创建唯一约束 会 自动创建唯一索引；二者都能实现对数据的唯一性约束</li>
<li>单独创建的唯一索引可以单独删除；唯一约束自动创建的唯一索引，唯一索引不能单独删除</li>
<li>想作为外键必须要有唯一约束</li>
</ul>
<blockquote>
<p>主键和外键</p>
</blockquote>
<p>索引都是伴随约束出现的，不能单独创建。这里不确定，个人猜测。</p>
<h3 id="5、创建、删除索引"><a href="#5、创建、删除索引" class="headerlink" title="5、创建、删除索引"></a>5、创建、删除索引</h3><p><strong>建议：</strong>一张表建的索引最好不要超过5个！</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 1、创建索引 [UNIQUE]表示唯一索引 */</span></span><br><span class="line">[<span class="keyword">UNIQUE</span>] INDEX sex1(sex)                        <span class="comment">-- 建表时为sex添加索引sex1</span></span><br><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">UNIQUE</span>] INDEX indexName <span class="keyword">ON</span> tabName(columnName);  <span class="comment">-- 可以绑定多个字段为一个索引</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2、删除索引 */</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX [indexName] <span class="keyword">ON</span> tabName;</span><br><span class="line"><span class="comment">/* 3、查看索引 */</span></span><br><span class="line"><span class="comment">/* 加上\G就可以以列的形式查看了 不加\G就是以表的形式查看 */</span></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> tabName \G;</span><br></pre></td></tr></table></figure>

<h3 id="6、索引使用建议"><a href="#6、索引使用建议" class="headerlink" title="6、索引使用建议"></a>6、索引使用建议</h3><blockquote>
<p>不要建索引的情况</p>
</blockquote>
<ul>
<li><p>记录太少的表。</p>
</li>
<li><p>经常增删改的表、频繁更新的字段不适合创建索引。</p>
</li>
<li><p><strong>Where条件、或者Order By 里用不到</strong>的字段不创建索引。</p>
</li>
<li><p>一个字段在整列中的属性值大部分都一样。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">假如一个表有10万行记录，有一个字段A只有true和false两种值，并且每个值的分布概率大约为50%，那么对A字段建索引一般不会提高数据库的查询速度。索引的选择性是指索引列中不同值的数目与表中记录数的比。如果一个表中有2000条记录，表索引列有1980个不同的值，那么这个索引的选择性就是1980/2000=0.99。一个索引的选择性越接近于1，这个索引的效率就越高。</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>需要建索引的情况</p>
</blockquote>
<ul>
<li>主键自动建立主键索引（唯一 + 非空）。外键、唯一约束自动建立索引。</li>
<li>频繁作为<code>查询条件where</code>  <code>查询中排序（order by）</code>的字段应该创建索引。</li>
<li>查询中与其他表关联的字段，<code>外键关系</code>建立索引，（MySQL外键字段添加索引，不加索引导致死锁）</li>
<li>查询中统计或者分组字段（因为group by也会用到排序）。</li>
</ul>
<blockquote>
<p>多表Join语句优化</p>
</blockquote>
<ul>
<li>尽可能减少<code>JOIN</code>语句中的<strong>嵌套循环</strong>的总次数：<strong>永远都是小的结果集驱动大的结果集</strong>。</li>
<li>左连接右边表建索引，保证<code>JOIN</code>语句中被驱动表上<code>JOIN</code>条件字段已经被索引。</li>
<li>当无法保证被驱动表的<code>JOIN</code>条件字段被索引且内存资源充足的前提下，不要太吝惜<code>Join Buffer</code> 的设置。</li>
</ul>
<h1 id="5、DML增删改查"><a href="#5、DML增删改查" class="headerlink" title="5、DML增删改查"></a>5、DML增删改查</h1><h2 id="5-1、DML语言之增删改"><a href="#5-1、DML语言之增删改" class="headerlink" title="5.1、DML语言之增删改"></a>5.1、DML语言之增删改</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 增</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student (id,name,pwd,sex)<span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">&#x27;wzh&#x27;</span>,<span class="number">123456</span>,<span class="string">&#x27;男&#x27;</span>)   </span><br><span class="line"><span class="comment">-- 增加操作，可以只增加部分值，剩下的不写，或者写NULL</span></span><br><span class="line"><span class="comment">-- 插入的值 可以用子查询的数据替代</span></span><br><span class="line"><span class="comment">-- 插入的数据可以用 NOW() 等函数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 改</span></span><br><span class="line">UPDATE student <span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;zk&#x27;</span>,pwd<span class="operator">=</span><span class="number">234</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>                </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>                     <span class="comment">-- 清空表后自增列不变</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="number">9</span><span class="operator">+</span><span class="number">2</span>)          <span class="comment">-- 可以利用子查询删除</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> student                     <span class="comment">-- 清空表会重新设置自增列，不会影响事务</span></span><br></pre></td></tr></table></figure>

<p> DELETE删除后重启数据库：    </p>
<ul>
<li>INNODB：自增列从1开始(存在内存中)</li>
<li>MYISAM：继续从上一个自增量开始</li>
</ul>
<h2 id="5-2、DML语言之查"><a href="#5-2、DML语言之查" class="headerlink" title="5.2、DML语言之查"></a>5.2、DML语言之查</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [ <span class="keyword">ALL</span> <span class="operator">|</span> <span class="keyword">DISTINCT</span> <span class="operator">|</span> DISTINCTROW <span class="operator">|</span> TOP ] </span><br><span class="line">&#123;<span class="operator">*</span><span class="operator">|</span>talbe.<span class="operator">*</span><span class="operator">|</span>[table.]field1[<span class="keyword">AS</span> alias1][,[table.]field2[<span class="keyword">AS</span> alias2][,…]]&#125;   <span class="comment">--- 查的字段</span></span><br><span class="line"><span class="keyword">FROM</span> 表名[<span class="keyword">as</span> 别名]    <span class="comment">-- 从哪些表中选择</span></span><br><span class="line">	[<span class="keyword">left</span> <span class="operator">|</span> <span class="keyword">right</span> <span class="operator">|</span> <span class="keyword">inner</span> <span class="keyword">join</span> 表名<span class="number">2</span> ]  <span class="comment">-- 联合查询</span></span><br><span class="line">[<span class="keyword">IN</span> externaldatabase] </span><br><span class="line">[<span class="keyword">WHERE</span>…]       <span class="comment">--  结果满足的条件</span></span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span>…]    <span class="comment">-- 按照那些字段分组</span></span><br><span class="line">[<span class="keyword">HAVING</span>…]      <span class="comment">-- 过滤分组记录满足的条件</span></span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span>…]    <span class="comment">-- 结果排序</span></span><br><span class="line">[limit ]       <span class="comment">-- 分页</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--注意： 必须严格按照顺序来</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>1、查询全部</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `student`</span><br></pre></td></tr></table></figure>

<blockquote>
<p>2、查询指定的字段（使用别名）</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s.`id` <span class="keyword">AS</span> ID <span class="keyword">FROM</span> `student` <span class="keyword">AS</span> s  <span class="comment">-- 字段使用``</span></span><br><span class="line"><span class="keyword">SELECT</span> s.`id` <span class="string">&#x27;ID&#x27;</span> <span class="keyword">FROM</span> `student` `s`    <span class="comment">-- 字段别名&#x27;&#x27;,表取别名``</span></span><br><span class="line"><span class="keyword">SELECT</span> s.id ID <span class="keyword">FROM</span> student s            <span class="comment">-- 不用任何字符</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>3、concat函数</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;学号:&#x27;</span>,id) <span class="keyword">AS</span> ID <span class="keyword">FROM</span> student <span class="comment">-- 拼接字符串</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>4、对结果操作</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> age<span class="operator">+</span><span class="number">1</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">11</span> </span><br></pre></td></tr></table></figure>

<blockquote>
<p>5、去重</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> `id` <span class="keyword">FROM</span> student    <span class="comment">-- 使用 DISTINCT</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> age,id <span class="keyword">FROM</span> <span class="keyword">USER</span>     <span class="comment">-- DISTINCT作用于所有列，如这里，只有id和age均相同，才会被去重 </span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>6、where筛选</p>
</blockquote>
<ul>
<li>算数运算判断：&lt;    &lt;    =   &gt;   &gt;=     !=    =     &lt;&gt;(name &lt;&gt; ‘张三’ 即名字不为张三)</li>
<li>逻辑比较判断：AND或者&amp;&amp;    OR或者||     NOT或者！</li>
<li>之间判断：        BETWEEN   AND</li>
<li>之内判断：       IN</li>
<li>模糊匹配：       LIKE</li>
<li>空值判断：       IS   [NOT]  NULL</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- mysql 优先计算And 其次计算 or</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">USER</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">6</span> <span class="keyword">OR</span> id <span class="operator">=</span> <span class="number">3</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">18</span> <span class="comment">-- id为6 或者 id为3且age为18</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">USER</span> <span class="keyword">WHERE</span> (id <span class="operator">=</span> <span class="number">6</span> <span class="keyword">OR</span> id <span class="operator">=</span> <span class="number">3</span>) <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">18</span>  <span class="comment">-- id为6或3 且 age为18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- MySQL的 NOT 支持对 BETWEEN、IN、EXISTS 搭配使用 </span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>7、模糊查询：比较运算符</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> age <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="keyword">BETWEEN</span> <span class="number">5</span> <span class="keyword">AND</span> <span class="number">12</span> 	<span class="comment">-- 查询区间</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> NAME <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;张%&#x27;</span>      <span class="comment">-- %表示任意字符,表示张....</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> NAME <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;张_&#x27;</span>      <span class="comment">-- _表示一个字符,表示张x</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> NAME <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="keyword">IN</span>(<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>)      <span class="comment">-- 查询id为11、12、13之内的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> NAME <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> addrss <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>   <span class="comment">-- 查询address不为空</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>8、使用正则表达式查询</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">USER</span> <span class="keyword">WHERE</span> NAME REGEXP <span class="string">&#x27;1000&#x27;</span>  <span class="comment">-- 使用正则表达式，匹配包含1000的字符串</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">USER</span> <span class="keyword">WHERE</span> NAME REGEXP <span class="string">&#x27;1000|2000&#x27;</span>  <span class="comment">--  与</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">USER</span> <span class="keyword">WHERE</span> NAME REGEXP <span class="string">&#x27;[JT]&#x27;</span>       <span class="comment">-- 字符为J或者T 等于 J|T</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">USER</span> <span class="keyword">WHERE</span> NAME REGEXP <span class="string">&#x27;[^J]&#x27;</span>       <span class="comment">-- 字符不为J</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>9、相等连接（内连接）</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 连接student表和teacher表中id相等的行</span></span><br><span class="line"><span class="keyword">SELECT</span> s.name <span class="keyword">FROM</span> student s,teacher t <span class="keyword">WHERE</span> s.id<span class="operator">=</span>t.id              <span class="comment">-- 使用where</span></span><br><span class="line"><span class="keyword">SELECT</span> s.name <span class="keyword">FROM</span> student s <span class="keyword">INNER</span> <span class="keyword">JOIN</span> teacher t <span class="keyword">ON</span> s.id<span class="operator">=</span>t.id   <span class="comment">-- 使用join连接</span></span><br><span class="line">                          <span class="comment">-- INNER可以省略</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>10、高级连接</p>
</blockquote>
<ul>
<li>左连接：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s.name,t.pwd <span class="keyword">FROM</span> student s <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> teacher t <span class="keyword">ON</span> s.id<span class="operator">=</span>t.id</span><br><span class="line"><span class="comment">-- 把student表的所有字段和teacher表的中满足条件的连接起来</span></span><br><span class="line"><span class="comment">-- 没有的字段会显示null</span></span><br><span class="line"><span class="comment">-- 此语句中会显示所有student表中的数据，满足内连接条件的会有t.pwd的值，其他都会显示为null</span></span><br><span class="line"><span class="comment">-- 直接left join也可以</span></span><br></pre></td></tr></table></figure>

<ul>
<li>右连接：左连接反过来</li>
<li>全连接：MySQL目前不支持</li>
<li>自连接</li>
</ul>
<blockquote>
<p>11、子查询:where语句中嵌套select语句，最多嵌套255层</p>
</blockquote>
<ul>
<li>返回单值</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s.name <span class="keyword">FROM</span> student s <span class="keyword">WHERE</span> s.id <span class="operator">=</span> (<span class="keyword">SELECT</span> t.id <span class="keyword">FROM</span> teacher t <span class="keyword">WHERE</span> t.name<span class="operator">=</span><span class="string">&#x27;李三&#x27;</span>)</span><br><span class="line"><span class="comment">-- &lt;  &gt; 等等</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>返回多值：必须使用多值比较运算符</p>
<p><strong>IN</strong></p>
<p><strong>ALL</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s.name <span class="keyword">FROM</span> student s <span class="keyword">WHERE</span> s.age <span class="operator">&gt;</span><span class="keyword">ALL</span>(<span class="keyword">SELECT</span> t.age <span class="keyword">FROM</span> teacher t <span class="keyword">WHERE</span> t.id<span class="operator">&gt;</span><span class="number">3</span>)                         <span class="comment">-- s.age必须大于所有返回的结果</span></span><br></pre></td></tr></table></figure>

<p><strong>ANY</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s.name <span class="keyword">FROM</span> student s <span class="keyword">WHERE</span> s.age <span class="operator">&gt;</span><span class="keyword">ANY</span>(<span class="keyword">SELECT</span> t.age <span class="keyword">FROM</span> teacher t <span class="keyword">WHERE</span> t.id<span class="operator">&gt;</span><span class="number">3</span>)                         <span class="comment">-- s.age大于其中某一个即可</span></span><br></pre></td></tr></table></figure>

<p><strong>EXISTS</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">-- 将外查询表的每一行，代入内查询作为检验，如果内查询返回的结果取非空值，则EXISTS子句返回TRUE，这一行行可作为外查询的结果行，否则不能作为结果。</span></span><br><span class="line"><span class="keyword">SELECT</span> s.age <span class="keyword">FROM</span> student s <span class="keyword">WHERE</span> <span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> teacher t <span class="keyword">WHERE</span> s.id<span class="operator">=</span>t.id)</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>子查询的作用</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">USER</span> <span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="number">3</span> <span class="keyword">AS</span> id)                  <span class="comment">-- 过滤数据 </span></span><br><span class="line"><span class="keyword">SELECT</span> id,NAME,(<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> o <span class="keyword">WHERE</span> o.id <span class="operator">=</span> c.id) <span class="keyword">FROM</span> c <span class="comment">-- 作为计算字段</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>12.合并查询结果</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 语句<span class="number">1</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> 语句<span class="number">2</span></span><br><span class="line"><span class="comment">-- 语句1和语句2查询的结果必须完全一致，Union自动去重</span></span><br><span class="line"><span class="comment">-- 只能使用一条order by 语句且在最后一条语句后面</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>13、分组过滤：</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id,name,pwd <span class="keyword">FROM</span> student <span class="keyword">GROUP</span> <span class="keyword">BY</span> name,id <span class="keyword">HAVING</span> id <span class="operator">&gt;</span><span class="number">4</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"><span class="comment">-- 所有相同的name的分成一组，每组的结果只选第一个</span></span><br><span class="line"><span class="comment">-- 可以按照多列分组</span></span><br><span class="line"><span class="comment">-- having只能和group by 一直使用，作用是进一步筛选</span></span><br><span class="line"><span class="comment">-- 通常配合聚合函数使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 配合聚合函数</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>14、排序</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">ASC</span>   <span class="comment">--  升序</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">DESC</span>  <span class="comment">--  降序</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>15、分页</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">ASC</span> LIMIT <span class="number">10</span>,<span class="number">3</span>  <span class="comment">-- 从第11行开始显示，每页3个数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">ASC</span> LIMIT <span class="number">10</span>    <span class="comment">-- 前10条语句</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">ASC</span> LIMIT <span class="number">10</span> <span class="keyword">OFFSET</span> <span class="number">3</span>; <span class="comment">-- 相当于 limit 3,10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">ASC</span> LIMIT <span class="number">10</span>,<span class="number">-1</span>  <span class="comment">-- 检索到最后一条数据</span></span><br></pre></td></tr></table></figure>

<h2 id="4-3、七种JOIN理论总结"><a href="#4-3、七种JOIN理论总结" class="headerlink" title="4.3、七种JOIN理论总结"></a>4.3、七种JOIN理论总结</h2><p><img src="/img/MySQL/3.jpg"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 1 */</span></span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A LEFT JOIN TableB B ON A.Key = B.Key;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2 */</span></span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A RIGHT JOIN TableB B ON A.Key = B.Key;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3 */</span></span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A INNER JOIN TableB B ON A.Key = B.Key;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4 */</span></span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A LEFT JOIN TableB B ON A.Key = B.Key WHERE B.Key IS NULL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 5 */</span></span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A RIGHT JOIN TableB B ON A.Key = B.Key WHERE A.Key IS NULL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 6 */</span></span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A FULL OUTER JOIN TableB B ON A.Key = B.Key;</span><br><span class="line"><span class="comment">/* MySQL不支持FULL OUTER JOIN这种语法 可以改成 1+2 */</span></span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A LEFT JOIN TableB B ON A.Key = B.Key</span><br><span class="line">UNION</span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A RIGHT JOIN TableB B ON A.Key = B.Key;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7 */</span></span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A FULL OUTER JOIN TableB B ON A.Key = B.Key WHERE A.Key IS NULL OR B.Key IS NULL;</span><br><span class="line"><span class="comment">/* MySQL不支持FULL OUTER JOIN这种语法 可以改成 4+5 */</span></span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A LEFT JOIN TableB B ON A.Key = B.Key WHERE B.Key IS NULL;</span><br><span class="line">UNION</span><br><span class="line">SELECT &lt;select_list&gt; FROM TableA A RIGHT JOIN TableB B ON A.Key = B.Key WHERE A.Key IS NULL;</span><br></pre></td></tr></table></figure>



<h1 id="6、DCL语句"><a href="#6、DCL语句" class="headerlink" title="6、DCL语句"></a>6、DCL语句</h1><h2 id="6-1、DCL：事务"><a href="#6-1、DCL：事务" class="headerlink" title="6.1、DCL：事务"></a>6.1、DCL：事务</h2><h3 id="1、事务原则"><a href="#1、事务原则" class="headerlink" title="1、事务原则"></a>1、事务原则</h3><ul>
<li>A   原子性：要么都成功，要么都失败</li>
<li>（consistency）一致性：在事务开始之前和事务结束以后，<strong>数据库的完整性</strong>没有被破坏。</li>
<li>（isolation）隔离性：多个事务互不影响</li>
<li>（durability）持久性：事务完成后，持久化</li>
</ul>
<h3 id="2、手动执行事务"><a href="#2、手动执行事务" class="headerlink" title="2、手动执行事务"></a>2、手动执行事务</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>   <span class="comment">-- 关闭事务，MySQL时默认开始事务提交的，要手动操作必须先关闭事务</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">1</span>   <span class="comment">-- 开启事务</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">START</span> TRANSACTION    <span class="comment">-- 事务开始</span></span><br><span class="line"><span class="keyword">COMMIT</span>               <span class="comment">-- 事务提交，一旦提交就持久化了</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SAVEPOINT</span> 保存点名               <span class="comment">-- 记录保存点，可以回滚到改点</span></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> <span class="keyword">SAVEPOINT</span> 保存点名   <span class="comment">-- 回滚</span></span><br><span class="line"><span class="keyword">RELEASE</span> <span class="keyword">SAVEPOINT</span> 保存点名       <span class="comment">-- 撤销保存点名</span></span><br></pre></td></tr></table></figure>

<h3 id="3、并发问题"><a href="#3、并发问题" class="headerlink" title="3、并发问题"></a>3、并发问题</h3><ul>
<li><strong>丢失更新：</strong>事务A 修改数据 1，然后事务B修改 数据 2，这样事务1的修改就被破坏了。</li>
<li><strong>读脏数据：</strong> 事务A读取了事务B更新的数据，然后B回滚操作，那么A读取到的数据是脏数据</li>
<li><strong>不可重复读：</strong>一个事务对同一数据两次读到的<strong>值</strong>不同</li>
<li><strong>幻影读：</strong>事务B对表 table 进行读取，在此过程中事务A对表 table 增加了一条数据，事务B修改完毕后发现还有一条数据没有读取，好像发生了幻影</li>
</ul>
<blockquote>
<p>事务隔离级别（大部分默认 可提交读 MySQL默认可重复读）</p>
</blockquote>
<table>
<thead>
<tr>
<th>级别</th>
<th>约束</th>
</tr>
</thead>
<tbody><tr>
<td>READ UNCOMMITTED（未提交读）</td>
<td>没有限制</td>
</tr>
<tr>
<td>READ COMMITTED（提交读）</td>
<td>不允许读未提交的数据，但是数据仍然可能在事务结束前被修改</td>
</tr>
<tr>
<td>REPEATABLE READ（可重复读）</td>
<td>保证一个事务中重复<strong>读到的数据保持同样的值</strong>，但允许其他用户将新幻影行插入数据集</td>
</tr>
<tr>
<td>SERIALIZABLE（可串行读）</td>
<td>不允许其他用户在事务完成前更新数据集或者将行插入到数据集</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>读脏数据</th>
<th>不可重复读</th>
<th>丢失更新</th>
<th>幻影读</th>
</tr>
</thead>
<tbody><tr>
<td>READ UNCOMMITTED（未提交读）</td>
<td>是</td>
<td>是</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>READ COMMITTED（已提交读）</td>
<td>否</td>
<td>是</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>REPEATABLE READ（可重复度）</td>
<td>否</td>
<td>否</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>SERIALIZABLE（可串行读）</td>
<td>否</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 设置MySQL连接的隔离级别</span></span><br><span class="line"><span class="keyword">set</span> transaction isolation level read committed;</span><br><span class="line"><span class="comment">-- 设置数据库系统的全局的隔离级别</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction isolation level read committed;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE  <span class="comment">-- 设置可串行读</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION    <span class="comment">-- 事务开始</span></span><br><span class="line"><span class="keyword">COMMIT</span>               <span class="comment">-- 事务提交</span></span><br></pre></td></tr></table></figure>

<h3 id="4、MySQL的表级锁（偏读）"><a href="#4、MySQL的表级锁（偏读）" class="headerlink" title="4、MySQL的表级锁（偏读）"></a>4、MySQL的表级锁（偏读）</h3><blockquote>
<p>特点</p>
</blockquote>
<p>偏向<code>MyISAM</code>存储引擎，开销小，加锁快，<strong>无死锁</strong>，锁定粒度大，发生锁冲突的概率最高，并发度最低。</p>
<blockquote>
<p>使用</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Lcok TABLES student READ;    <span class="comment">-- 上锁，读锁    WRITE为写锁</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">OPEN</span> TABLES;            <span class="comment">-- 查看数据库表锁的命令</span></span><br><span class="line">UNLOCK <span class="keyword">TABLE</span>;                <span class="comment">-- 解锁</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>案例说明</p>
</blockquote>
<p><strong>案例说明—-读锁：</strong>自己不能修改，同时限制他人修改直到自己释放锁。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">条件：打开两个会话，`SESSION1`为`mylock`表添加读锁。</span><br><span class="line"></span><br><span class="line">- SESSION1 可以读mylock表、不可以修改mylock表、不可以读其他的表</span><br><span class="line">- SESSION2 可以读mylock表、修改mylock表会被阻塞，需要等待SESSION1释放mylock表。可以读其他表</span><br></pre></td></tr></table></figure>

<p><strong>案例说明—-写锁：</strong>自己可以修改，同时限制他人操作该表直到自己释放锁。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">条件：打开两个会话，`SESSION1`为`mylock`表添加写锁。</span><br><span class="line"></span><br><span class="line">- SESSION1 可以读mylock的表、可以修改mylock表、不可以读其他的表</span><br><span class="line">- SESSION2 不可以读mylock表、修改mylock表会被阻塞，需要等待SESSION1释放mylock表、可以读其他表</span><br></pre></td></tr></table></figure>

<blockquote>
<p>结论</p>
</blockquote>
<ol>
<li>MYISAM默认 <code>查询加读锁，更新加写锁</code>。并且MYISAM优先分配写锁，即使读请求的等待队列的顺序比写请求更前， 这也是<code>MyISAM</code>不适合作为读操作高的数据库的引擎。</li>
<li>MySQL的表级锁有读写两种模式，让自己按锁种类获取对表的 读写权限，同时限制其他回话对该表的 写，需要注意的是，获得了一个表的锁，就只能操作该表。</li>
</ol>
<h3 id="5、MySQL的行级锁（偏写）"><a href="#5、MySQL的行级锁（偏写）" class="headerlink" title="5、MySQL的行级锁（偏写）"></a>5、MySQL的行级锁（偏写）</h3><blockquote>
<p>特点</p>
</blockquote>
<p>偏向<code>InnoDB</code>存储引擎，开销大，加锁慢；会出现<strong>死锁</strong>；锁定粒度最小，发生锁冲突的概率最低，并发度最高。</p>
<p><img src="/img/MySQL/6.jpg"></p>
<ul>
<li>共享锁（S）：允许一个事务去读一行，<strong>阻止</strong>其他事务获得相同数据集的<strong>排他锁</strong>。</li>
<li>排他锁（X)：允许获得排他锁的事务更新数据，<strong>阻止</strong>其他事务取得相同数据集的<strong>共享读锁和排他写锁</strong>。</li>
</ul>
<p><strong>注意：</strong>为了允许行锁和表锁共存，实现多粒度锁机制，InnoDB还有两种内部使用的意向锁（Intention Locks），这两种意向锁都是表锁。</p>
<ul>
<li>意向共享锁（IS）：事务打算给数据行加行共享锁，事务在给一个数据行加共享锁前必须先取得该表的IS锁。</li>
<li>意向排他锁（IX）：事务打算给数据行加行排他锁，事务在给一个数据行加排他锁前必须先取得该表的IX锁。</li>
</ul>
<blockquote>
<p>使用</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> LOCK <span class="keyword">IN</span> SHARE MODE;     <span class="comment">-- 共享锁（读锁）、允许其他会话读</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> UPDATE;             <span class="comment">-- 排他锁（写锁）、禁止其他会话读</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 默认增删改语句MySQL会自动加上隐式排它锁、select不会加锁</span></span><br><span class="line"><span class="keyword">commit</span>               <span class="comment">---提交后自动解锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注意，如果用SELECT ... IN SHARE MODE获得共享锁，然后当前事务又需要更新，那么就会获取写锁，由于不支持锁升级，所以会死锁。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>原理</p>
</blockquote>
<p>InnoDB行锁是通过<strong>给索引上的索引项加锁</strong>来实现的，这一点MySQL与Oracle不同，后者是通过在数据块中对相应数据行加锁来实现的。InnoDB这种行锁实现特点意味着：只有通过索引条件检索数据，InnoDB才使用行级锁，否则，InnoDB将使用表锁！表锁之间没有冲突！会导致并发问题。</p>
<blockquote>
<p>案例</p>
</blockquote>
<p><strong>总结：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 案例1</span></span><br><span class="line">UPDATE `test_innodb_lock` <span class="keyword">SET</span> `b` <span class="operator">=</span> <span class="string">&#x27;88&#x27;</span> <span class="keyword">WHERE</span> `a` <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- SESSION1写操作，但是没有commit。</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test_innodb_lock`;      <span class="comment">-- SESSION2是读不到SESSION1未提交的数据的。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 案例2</span></span><br><span class="line">UPDATE `test_innodb_lock` <span class="keyword">SET</span> `b` <span class="operator">=</span> <span class="string">&#x27;99&#x27;</span> <span class="keyword">WHERE</span> `a` <span class="operator">=</span> <span class="number">1</span>;    <span class="comment">-- SESSION1写操作，但是没有commit</span></span><br><span class="line">UPDATE `test_innodb_lock` <span class="keyword">SET</span> `b` <span class="operator">=</span> <span class="string">&#x27;asdasd&#x27;</span> <span class="keyword">WHERE</span> `a` <span class="operator">=</span> <span class="number">1</span>; <span class="comment">-- SESSION2写操作会阻塞到1执行完</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 案例3</span></span><br><span class="line">UPDATE `test_innodb_lock` <span class="keyword">SET</span> `b` <span class="operator">=</span> <span class="string">&#x27;8976&#x27;</span> <span class="keyword">WHERE</span> `a` <span class="operator">=</span> <span class="number">6</span>;   <span class="comment">-- SESSION1写操作，</span></span><br><span class="line">UPDATE `test_innodb_lock` <span class="keyword">SET</span> `b` <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span> <span class="keyword">WHERE</span> `a` <span class="operator">=</span> <span class="number">4</span>;  <span class="comment">-- SESSION2写操作其他行不受影响</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 案例4 索引失效行锁变表锁</span></span><br><span class="line">UPDATE `test_innodb_lock` <span class="keyword">SET</span> `a` <span class="operator">=</span> <span class="number">888</span> <span class="keyword">WHERE</span> `b` <span class="operator">=</span> <span class="number">8000</span>;  <span class="comment">-- `b`没有加单引号，索引失效</span></span><br><span class="line">UPDATE `test_innodb_lock` <span class="keyword">SET</span> `b` <span class="operator">=</span> <span class="string">&#x27;1314&#x27;</span> <span class="keyword">WHERE</span> `a` <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 操作不同行，但是阻塞</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li><code>InnoDB</code>实现了行级锁定，虽然性能损耗高，但是锁的粒度低，所以并发的效果好。</li>
<li>但是，<code>InnoDB</code>的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让<code>InnoDB</code>的整体性能表现不仅不能比<code>MyISAM</code>高，甚至可能会更差。</li>
</ul>
<h3 id="6、间隙锁"><a href="#6、间隙锁" class="headerlink" title="6、间隙锁"></a>6、间隙锁</h3><blockquote>
<p>锁粒度分类</p>
</blockquote>
<ul>
<li>Record lock：单个⾏记录上的锁</li>
<li>Gap lock：间隙锁，锁定⼀个范围，不包括记录本身</li>
<li>Next-key lock：record+gap 锁定⼀个范围，包含记录本身（行级锁使用）</li>
</ul>
<p><strong>注意：</strong>Gap锁设计的目的是为了阻止多个事务将记录插入到同⼀范围内，⽽这会导致幻影读的产生。</p>
<blockquote>
<p>间隙锁</p>
</blockquote>
<p><strong>概念：</strong>当我们用<code>范围条件</code>而不是相等条件检索数据，并请求共享或者排他锁时，<code>InnoDB</code>会给符合条件的已有数据记录的索引项加锁，对于键值在条件范围内但并不存在的记录，叫做”间隙(GAP)”。</p>
<p><code>InnoDB</code>也会对这个”间隙”加锁，这种锁的机制就是所谓的”间隙锁”。</p>
<p><strong>危害：</strong>对于这个不存在的间隙，如果想要添加，那么就会添加失败，对性能造成危害。</p>
<p><strong>禁用：</strong> A. 将事务隔离级别设置为RC B. 将参数innodb_locks_unsafe_for_binlog设置为1</p>
<h2 id="6-2、DCL：权限管理"><a href="#6-2、DCL：权限管理" class="headerlink" title="6.2、DCL：权限管理"></a>6.2、DCL：权限管理</h2><blockquote>
<p>用户管理</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> wzh<span class="variable">@localhost</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>    <span class="comment">-- 创建用户wzh，密码123456</span></span><br><span class="line">	        <span class="comment">-- @后面是主机名，如果指定了那么创建的用户必须通过该主机连接</span></span><br><span class="line">	        <span class="comment">-- 并且修改也必须带上@主机名</span></span><br><span class="line"><span class="keyword">SET</span> PASSWORD <span class="operator">=</span> PASSWORD(<span class="string">&#x27;123456&#x27;</span>)                     <span class="comment">-- 修改本机密码</span></span><br><span class="line"><span class="keyword">SET</span> PASSWORD <span class="keyword">FOR</span> wzh<span class="variable">@localhost</span> <span class="operator">=</span> PASSWORD(<span class="string">&#x27;1234566&#x27;</span>)  <span class="comment">-- 指定用户修改密码</span></span><br><span class="line">RENAME <span class="keyword">USER</span> wzh<span class="variable">@localhost</span> <span class="keyword">TO</span> wzh                      <span class="comment">-- 更改用户名</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> wzh                                         <span class="comment">-- 删除用户</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>权限管理</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> wzh    <span class="comment">-- 授权对所有表的所有权限给wzh用户</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> school.student <span class="keyword">TO</span> wzh  <span class="comment">--只给school数据库的student表的所有权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> wzh                   <span class="comment">-- 显示用户wzh的权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">FROM</span> wzh <span class="comment">-- 撤销权限</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>角色管理：MySQL8.0新增</p>
</blockquote>
<p>如果用户被授予角色权限，则该用户拥有该角色的权限。</p>
<h1 id="7、数据库的备份"><a href="#7、数据库的备份" class="headerlink" title="7、数据库的备份"></a>7、数据库的备份</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导出  导出：多张表不要加逗号，用空格就行</span></span><br><span class="line"><span class="comment">--         主机名                      数据库  表          文件名      </span></span><br><span class="line">mysqldump <span class="operator">-</span>hlocalhost <span class="operator">-</span>uroot <span class="operator">-</span>p123456 school student <span class="operator">&gt;</span>D:<span class="operator">/</span>a.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 导入</span></span><br><span class="line">source d:<span class="operator">/</span>a.sql                     <span class="comment">-- 已经登录</span></span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456 库名<span class="operator">&lt;</span>备份文件   <span class="comment">-- 未登录</span></span><br></pre></td></tr></table></figure>



<h1 id="8、MySQL索引失效"><a href="#8、MySQL索引失效" class="headerlink" title="8、MySQL索引失效"></a>8、MySQL索引失效</h1><blockquote>
<p>数据准备</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `staffs`(</span><br><span class="line">`id` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">`name` <span class="type">VARCHAR</span>(<span class="number">24</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">`age` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">`pos` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;职位&#x27;</span>,</span><br><span class="line">`add_time` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;入职时间&#x27;</span></span><br><span class="line">)COMMENT <span class="string">&#x27;员工记录表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `staffs`(`name`,`age`,`pos`) <span class="keyword">VALUES</span>(<span class="string">&#x27;Ringo&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;manager&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `staffs`(`name`,`age`,`pos`) <span class="keyword">VALUES</span>(<span class="string">&#x27;张三&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;dev&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `staffs`(`name`,`age`,`pos`) <span class="keyword">VALUES</span>(<span class="string">&#x27;李四&#x27;</span>, <span class="number">21</span>, <span class="string">&#x27;dev&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 创建索引 */</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_staffs_name_age_pos <span class="keyword">ON</span> `staffs`(`name`,`age`,`pos`);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>索引失效的情况</p>
</blockquote>
<ul>
<li>最佳左前缀法则</li>
<li>不在索引列上做任何操作（计算、函数、(自动or手动)类型转换）</li>
<li>索引中范围条件右边的字段会全部失效。</li>
<li>尽量使用覆盖索引（只访问索引的查询，索引列和查询列一致），减少<code>SELECT *</code>。</li>
<li>MySQL在使用<code>!=</code>、<code>&lt;&gt;</code>、<code>is null</code>、<code>is not null</code>索引失效</li>
<li><code>like</code>以通配符开头<code>%abc</code>索引失效会变成全表扫描。</li>
<li>字符串不加单引号，容易导致类型转换，最终索引失效。</li>
<li>少用<code>or</code>，用它来连接时会索引失效。</li>
</ul>
<h2 id="8-1、最佳左前缀法则"><a href="#8-1、最佳左前缀法则" class="headerlink" title="8.1、最佳左前缀法则"></a>8.1、最佳左前缀法则</h2><p><strong>概念：</strong>复合索引（A，B，C），索引B生效的条件是必须用到A字段，C生效条件是必须用到A和B</p>
<ul>
<li>order by 、group by算使用到，但是要严格按照顺序 where B group by A，C    不失效  ;  顺序变 C，A 则失效</li>
<li>select A  where  A   and  C    group by B ，注意C会失效，因为是先查询后排序</li>
<li>select B where  A  and  B  and  C  group by C，B         主要之前用到索引，那么之后可以不参与排序。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> A  <span class="keyword">where</span> A <span class="keyword">group</span> <span class="keyword">by</span> B,D             <span class="comment">-- B生效，但是D不生效</span></span><br><span class="line"><span class="keyword">select</span> A,D  <span class="keyword">where</span> A <span class="keyword">group</span> <span class="keyword">by</span> B,D           <span class="comment">-- B生效，但是D不生效</span></span><br><span class="line"><span class="keyword">select</span> A,D  <span class="keyword">where</span> A <span class="keyword">and</span> D <span class="keyword">group</span> <span class="keyword">by</span> B,D     <span class="comment">-- B生效，若D为索引则生效，如有符合索引(A，D) 则也生效。</span></span><br><span class="line"></span><br><span class="line">对于复合索引，只要<span class="keyword">select</span>的为其中的一部分即可。普通索引，必须查询该字段才使用。</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 用到了idx_staffs_name_age_pos索引中的name字段 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 用到了idx_staffs_name_age_pos索引中的name, age字段 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span> <span class="keyword">AND</span> `age` <span class="operator">=</span> <span class="number">18</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 用到了idx_staffs_name_age_pos索引中的name，age，pos字段 这是属于全值匹配的情况！！！*/</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span> <span class="keyword">AND</span> `age` <span class="operator">=</span> <span class="number">18</span> <span class="keyword">AND</span> `pos` <span class="operator">=</span> <span class="string">&#x27;manager&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 索引没用上，ALL全表扫描 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `age` <span class="operator">=</span> <span class="number">18</span> <span class="keyword">AND</span> `pos` <span class="operator">=</span> <span class="string">&#x27;manager&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 索引没用上，ALL全表扫描 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `pos` <span class="operator">=</span> <span class="string">&#x27;manager&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 用到了idx_staffs_name_age_pos索引中的name字段，pos字段索引失效 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span> <span class="keyword">AND</span> `pos` <span class="operator">=</span> <span class="string">&#x27;manager&#x27;</span>;  <span class="comment">-- </span></span><br></pre></td></tr></table></figure>

<h2 id="8-2、索引列上不计算"><a href="#8-2、索引列上不计算" class="headerlink" title="8.2、索引列上不计算"></a>8.2、索引列上不计算</h2><p><strong>概念：</strong>where 语句后面的某条件上进行了计算，该索引失效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span>;           <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> <span class="keyword">LEFT</span>(`name`, <span class="number">5</span>) <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span>;  <span class="comment">-- 失效</span></span><br></pre></td></tr></table></figure>

<h2 id="8-3、范围之后全失效"><a href="#8-3、范围之后全失效" class="headerlink" title="8.3、范围之后全失效"></a>8.3、范围之后全失效</h2><p><strong>概念：</strong>where 语句后面的某条件如 xx &gt; xx ，在这之后的语句索引失效  或者 in  之类的也失效</p>
<p><strong>注意：</strong>范围的限制不会影响到后面的 排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 用到了idx_staffs_name_age_pos索引中的name，age，pos字段 这是属于全值匹配的情况！！！*/</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span> <span class="keyword">AND</span> `age` <span class="operator">=</span> <span class="number">18</span> <span class="keyword">AND</span> `pos` <span class="operator">=</span> <span class="string">&#x27;manager&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 用到了idx_staffs_name_age_pos索引中的name，age字段，pos字段索引失效 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">AND</span> `age` <span class="operator">&gt;</span> <span class="number">18</span> <span class="keyword">AND</span> `pos` <span class="operator">=</span> <span class="string">&#x27;dev&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="8-4、覆盖索引尽量用"><a href="#8-4、覆盖索引尽量用" class="headerlink" title="8.4、覆盖索引尽量用"></a>8.4、覆盖索引尽量用</h2><p><strong>覆盖索引：</strong>数据列只用从索引中就能够取得，不必从数据表中读取，即查询列要被所使用的索引覆盖。</p>
<p>所以在写SQL的不要使用<code>SELECT *</code>，用什么字段就查询什么字段。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 没有用到覆盖索引</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span> <span class="keyword">AND</span> `age` <span class="operator">=</span> <span class="number">18</span> <span class="keyword">AND</span> `pos` <span class="operator">=</span> <span class="string">&#x27;manager&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用到了覆盖索引</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> `name`, `age`, `pos` <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span> <span class="keyword">AND</span> `age` <span class="operator">=</span> <span class="number">18</span> <span class="keyword">AND</span> `pos` <span class="operator">=</span> <span class="string">&#x27;manager&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- addrss无索引  name 有索引</span></span><br><span class="line">explain <span class="keyword">select</span> addrss <span class="keyword">from</span> student <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> name;   <span class="comment">-- 失效</span></span><br><span class="line">explain <span class="keyword">select</span> addrss <span class="keyword">from</span> student <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> name;   <span class="comment">-- 有效</span></span><br></pre></td></tr></table></figure>

<h2 id="8-5、不等有时会失效"><a href="#8-5、不等有时会失效" class="headerlink" title="8.5、不等有时会失效"></a>8.5、不等有时会失效</h2><p><strong>概念：</strong>where语句 使用  !=  索引有时候会失效 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> `name`, `age`, `pos` <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">!=</span> <span class="string">&#x27;Ringo&#x27;</span>;  <span class="comment">-- 成功</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">!=</span> <span class="string">&#x27;Ringo&#x27;</span>;           <span class="comment">-- 失败</span></span><br></pre></td></tr></table></figure>

<h2 id="8-6、like百分加右边"><a href="#8-6、like百分加右边" class="headerlink" title="8.6、like百分加右边"></a>8.6、like百分加右边</h2><p><strong>概念</strong>： like  “%xxxxx” 这种形式索引会失效    _  没事</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="keyword">LIKE</span> <span class="string">&#x27;%ing%&#x27;</span>;    <span class="comment">-- 失败</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="keyword">LIKE</span> <span class="string">&#x27;%ing&#x27;</span>;     <span class="comment">-- 失败</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="keyword">LIKE</span> <span class="string">&#x27;Rin%&#x27;</span>;     <span class="comment">-- 成功</span></span><br></pre></td></tr></table></figure>

<h2 id="8-7、字符要加单引号"><a href="#8-7、字符要加单引号" class="headerlink" title="8.7、字符要加单引号"></a>8.7、字符要加单引号</h2><p><strong>概念：</strong>字符串不加单引号容易发生强制类型转换，索引失效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> `id`, `name` <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="number">2000</span>;   <span class="comment">-- 使用覆盖索引，未失效</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `staffs` <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="number">2000</span>;      <span class="comment">-- 失效</span></span><br></pre></td></tr></table></figure>

<h2 id="8-8、索引相关题目"><a href="#8-8、索引相关题目" class="headerlink" title="8.8、索引相关题目"></a>8.8、索引相关题目</h2><p><strong>假设index(a,b,c)</strong></p>
<table>
<thead>
<tr>
<th>Where语句</th>
<th>索引是否被使用</th>
</tr>
</thead>
<tbody><tr>
<td>where a = 3</td>
<td>Y，使用到a</td>
</tr>
<tr>
<td>where a = 3 and b = 5</td>
<td>Y，使用到a，b</td>
</tr>
<tr>
<td>where a = 3 and b = 5 and c = 4</td>
<td>Y，使用到a，b，c</td>
</tr>
<tr>
<td>where b = 3 或者 where b = 3 and c = 4 或者 where c = 4</td>
<td>N，没有用到a字段</td>
</tr>
<tr>
<td>where a = 3 and c = 5</td>
<td>使用到a，但是没有用到c，因为b断了</td>
</tr>
<tr>
<td>where a = 3 and b &gt; 4 and c = 5</td>
<td>使用到a，b，但是没有用到c，因为c在范围之后</td>
</tr>
<tr>
<td>where a = 3 and b like ‘kk%’ and c = 4</td>
<td>Y，a，b，c都用到</td>
</tr>
<tr>
<td>where a = 3 and b like ‘%kk’ and c = 4</td>
<td>只用到a</td>
</tr>
<tr>
<td>where a = 3 and b like ‘%kk%’ and c = 4</td>
<td>只用到a</td>
</tr>
<tr>
<td>where a = 3 and b like ‘k%kk%’ and c = 4</td>
<td>Y，a，b，c都用到</td>
</tr>
</tbody></table>
<h2 id="8-9、面试题分析"><a href="#8-9、面试题分析" class="headerlink" title="8.9、面试题分析"></a>8.9、面试题分析</h2><blockquote>
<p>数据准备</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 创建表 */</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test03`(</span><br><span class="line">`id` <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">`c1` <span class="type">CHAR</span>(<span class="number">10</span>),</span><br><span class="line">`c2` <span class="type">CHAR</span>(<span class="number">10</span>),</span><br><span class="line">`c3` <span class="type">CHAR</span>(<span class="number">10</span>),</span><br><span class="line">`c4` <span class="type">CHAR</span>(<span class="number">10</span>),</span><br><span class="line">`c5` <span class="type">CHAR</span>(<span class="number">10</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 插入数据 */</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test03`(`c1`,`c2`,`c3`,`c4`,`c5`) <span class="keyword">VALUES</span>(<span class="string">&#x27;a1&#x27;</span>,<span class="string">&#x27;a2&#x27;</span>,<span class="string">&#x27;a3&#x27;</span>,<span class="string">&#x27;a4&#x27;</span>,<span class="string">&#x27;a5&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test03`(`c1`,`c2`,`c3`,`c4`,`c5`) <span class="keyword">VALUES</span>(<span class="string">&#x27;b1&#x27;</span>,<span class="string">&#x27;b22&#x27;</span>,<span class="string">&#x27;b3&#x27;</span>,<span class="string">&#x27;b4&#x27;</span>,<span class="string">&#x27;b5&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test03`(`c1`,`c2`,`c3`,`c4`,`c5`) <span class="keyword">VALUES</span>(<span class="string">&#x27;c1&#x27;</span>,<span class="string">&#x27;c2&#x27;</span>,<span class="string">&#x27;c3&#x27;</span>,<span class="string">&#x27;c4&#x27;</span>,<span class="string">&#x27;c5&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test03`(`c1`,`c2`,`c3`,`c4`,`c5`) <span class="keyword">VALUES</span>(<span class="string">&#x27;d1&#x27;</span>,<span class="string">&#x27;d2&#x27;</span>,<span class="string">&#x27;d3&#x27;</span>,<span class="string">&#x27;d4&#x27;</span>,<span class="string">&#x27;d5&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `test03`(`c1`,`c2`,`c3`,`c4`,`c5`) <span class="keyword">VALUES</span>(<span class="string">&#x27;e1&#x27;</span>,<span class="string">&#x27;e2&#x27;</span>,<span class="string">&#x27;e3&#x27;</span>,<span class="string">&#x27;e4&#x27;</span>,<span class="string">&#x27;e5&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 创建复合索引 */</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_test03_c1234 <span class="keyword">ON</span> `test03`(`c1`,`c2`,`c3`,`c4`);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>题目</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 最好索引怎么创建的，就怎么用，按照顺序使用，避免让MySQL再自己去翻译一次 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 1.全值匹配 用到索引c1 c2 c3 c4全字段 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">AND</span> `c3` <span class="operator">=</span> <span class="string">&#x27;a3&#x27;</span> <span class="keyword">AND</span> `c4` <span class="operator">=</span> <span class="string">&#x27;a4&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">AND</span> `c4` <span class="operator">=</span> <span class="string">&#x27;a4&#x27;</span> <span class="keyword">AND</span> `c3` <span class="operator">=</span> <span class="string">&#x27;a3&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c4` <span class="operator">=</span> <span class="string">&#x27;a4&#x27;</span> <span class="keyword">AND</span> `c3` <span class="operator">=</span> <span class="string">&#x27;a3&#x27;</span> <span class="keyword">AND</span> `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">AND</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4.用到索引c1 c2 c3字段，c4字段失效，范围之后全失效 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">AND</span> `c3` <span class="operator">&gt;</span> <span class="string">&#x27;a3&#x27;</span> <span class="keyword">AND</span> `c4` <span class="operator">=</span> <span class="string">&#x27;a4&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 5.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">AND</span> `c4` <span class="operator">&gt;</span> <span class="string">&#x27;a4&#x27;</span> <span class="keyword">AND</span> `c3` <span class="operator">=</span> <span class="string">&#x27;a3&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">   6.用到了索引c1 c2 c3三个字段, c1和c2两个字段用于查找,  c3字段用于排序了但是没有统计到key_len中，c4字段失效因为先查询，后排序</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">AND</span> `c4` <span class="operator">=</span> <span class="string">&#x27;a4&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `c3`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7.用到了索引c1 c2 c3三个字段，c1和c2两个字段用于查找, c3字段用于排序了但是没有统计到key_len中*/</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `c3`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">   8.用到了索引c1 c2两个字段，c4失效，c1和c2两个字段用于查找，c4字段排序产生了Using filesort说明排序没有用到c4字段 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `c4`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 9.用到了索引c1 c2 c3三个字段，c1用于查找，c2和c3用于排序 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c5` <span class="operator">=</span> <span class="string">&#x27;a5&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `c2`, `c3`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 10.用到了c1一个字段，c1用于查找，c3和c2两个字段索引失效，产生了Using filesort */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c5` <span class="operator">=</span> <span class="string">&#x27;a5&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `c3`, `c2`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 11.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span>  `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> c2, c3;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 12.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span>  `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">AND</span> `c5` <span class="operator">=</span> <span class="string">&#x27;a5&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> c2, c3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">重要 </span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">   13.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 没有产生Using filesort </span></span><br><span class="line"><span class="comment">      因为之前c2这个字段已经确定了是&#x27;a2&#x27;了，这是一个常量，再去ORDER BY c3,c2 这时候c2已经不用排序了！</span></span><br><span class="line"><span class="comment">      所以没有产生Using filesort 和(10)进行对比学习！</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c2` <span class="operator">=</span> <span class="string">&#x27;a2&#x27;</span> <span class="keyword">AND</span> `c5` <span class="operator">=</span> <span class="string">&#x27;a5&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> c3, c2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* GROUP BY 表面上是叫做分组，但是分组之前必定排序 。 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 14.用到c1 c2 c3三个字段，c1用于查找，c2 c3用于排序，c4失效 */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c4` <span class="operator">=</span> <span class="string">&#x27;a4&#x27;</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> `c2`,`c3`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 15.用到c1这一个字段，c4失效，c2和c3排序失效产生了Using filesort */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `test03` <span class="keyword">WHERE</span> `c1` <span class="operator">=</span> <span class="string">&#x27;a1&#x27;</span> <span class="keyword">AND</span> `c4` <span class="operator">=</span> <span class="string">&#x27;a4&#x27;</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> `c3`,`c2`;</span><br></pre></td></tr></table></figure>

<p><code>GROUP BY</code>基本上都需要进行排序，索引优化几乎和<code>ORDER BY</code>一致，但是<code>GROUP BY</code>会有临时表的产生。</p>
<h2 id="8-10、总结"><a href="#8-10、总结" class="headerlink" title="8.10、总结"></a>8.10、总结</h2><p>索引优化的一般性建议：</p>
<ul>
<li>对于单值索引，尽量选择针对当前<code>query</code>过滤性更好的索引。</li>
<li>在选择复合索引的时候，当前<code>query</code>中过滤性最好的字段在索引字段顺序中，位置越靠前越好。</li>
<li>在选择复合索引的时候，尽量选择可以能够包含当前<code>query</code>中的<code>where</code>子句中更多字段的索引。</li>
<li>尽可能通过分析统计信息和调整<code>query</code>的写法来达到选择合适索引的目的。</li>
</ul>
<p>口诀：</p>
<ul>
<li>带头大哥不能死。</li>
<li>中间兄弟不能断。</li>
<li>索引列上不计算。</li>
<li>范围之后全失效。</li>
<li>覆盖索引尽量用。</li>
<li>不等有时会失效。</li>
<li>like百分加右边。</li>
<li>字符要加单引号。</li>
<li>一般SQL少用or。</li>
</ul>
<h1 id="9、MySQL查询优化"><a href="#9、MySQL查询优化" class="headerlink" title="9、MySQL查询优化"></a>9、MySQL查询优化</h1><h2 id="9-1、小表驱动大表"><a href="#9-1、小表驱动大表" class="headerlink" title="9.1、小表驱动大表"></a>9.1、小表驱动大表</h2><blockquote>
<p>优化原则：对于MySQL数据库而言，永远都是小表驱动大表。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 举个例子：可以使用嵌套的for循环来理解小表驱动大表。</span></span><br><span class="line"><span class="comment">* 以下两个循环结果都是一样的，但是对于MySQL来说不一样，</span></span><br><span class="line"><span class="comment">* 第一种可以理解为，和MySQL建立5次连接每次查询1000次。</span></span><br><span class="line"><span class="comment">* 第二种可以理解为，和MySQL建立1000次连接每次查询5次。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i ++)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= <span class="number">1000</span>; j++)&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">1000</span>; i ++)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= <span class="number">5</span>; j++)&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>IN和EXISTS</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 优化原则：小表驱动大表，即小的数据集驱动大的数据集 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IN适合B表比A表数据小的情况*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `A` <span class="keyword">WHERE</span> `id` <span class="keyword">IN</span> (<span class="keyword">SELECT</span> `id` <span class="keyword">FROM</span> `B`)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* EXISTS适合B表比A表数据大的情况 */</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `A` <span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> `B` <span class="keyword">WHERE</span> `B`.id <span class="operator">=</span> `A`.id);</span><br></pre></td></tr></table></figure>

<p><strong>EXISTS：</strong></p>
<ul>
<li>语法：<code>SELECT....FROM tab WHERE EXISTS(subquery);</code>该语法可以理解为：</li>
<li>该语法可以理解为：将主查询的数据，放到子查询中做条件验证，根据验证结果（<code>true</code>或是<code>false</code>）来决定主查询的数据结果是否得以保留。</li>
</ul>
<p><strong>提示：</strong></p>
<ul>
<li><code>EXISTS(subquery)</code>子查询只返回<code>true</code>或者<code>false</code>，因此子查询中的<code>SELECT *</code>可以是<code>SELECT 1 OR SELECT X</code>，它们并没有区别。</li>
<li><code>EXISTS(subquery)</code>子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比，如果担心效率问题，可进行实际检验以确定是否有效率问题。</li>
<li><code>EXISTS(subquery)</code>子查询往往也可以用条件表达式，其他子查询或者<code>JOIN</code>替代，何种最优需要具体问题具体分析。</li>
</ul>
<h2 id="9-2、ORDER-BY优化"><a href="#9-2、ORDER-BY优化" class="headerlink" title="9.2、ORDER BY优化"></a>9.2、ORDER BY优化</h2><blockquote>
<p>数据准备</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `talA`(</span><br><span class="line">`age` <span class="type">INT</span>,</span><br><span class="line">`birth` <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `talA`(`age`) <span class="keyword">VALUES</span>(<span class="number">18</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `talA`(`age`) <span class="keyword">VALUES</span>(<span class="number">19</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `talA`(`age`) <span class="keyword">VALUES</span>(<span class="number">20</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `talA`(`age`) <span class="keyword">VALUES</span>(<span class="number">21</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `talA`(`age`) <span class="keyword">VALUES</span>(<span class="number">22</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `talA`(`age`) <span class="keyword">VALUES</span>(<span class="number">23</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `talA`(`age`) <span class="keyword">VALUES</span>(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `talA`(`age`) <span class="keyword">VALUES</span>(<span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 创建索引 */</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_talA_age_birth <span class="keyword">ON</span> `talA`(`age`, `birth`);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>案例</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 1.使用索引进行排序了 不会产生Using filesort */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `talA` <span class="keyword">WHERE</span> `age` <span class="operator">&gt;</span> <span class="number">20</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `age`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2.使用索引进行排序了 不会产生Using filesort */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `talA` <span class="keyword">WHERE</span> `age` <span class="operator">&gt;</span> <span class="number">20</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `age`,`birth`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3.没有使用索引进行排序 产生了Using filesort */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `talA` <span class="keyword">WHERE</span> `age` <span class="operator">&gt;</span> <span class="number">20</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `birth`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4.没有使用索引进行排序 产生了Using filesort */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `talA` <span class="keyword">WHERE</span> `age` <span class="operator">&gt;</span> <span class="number">20</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `birth`,`age`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 5.没有使用索引进行排序 产生了Using filesort */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `talA` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `birth`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 6.没有使用索引进行排序 产生了Using filesort */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `talA` <span class="keyword">WHERE</span> `birth` <span class="operator">&gt;</span> <span class="string">&#x27;2020-08-04 07:42:21&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `birth`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 7.使用索引进行排序了 不会产生Using filesort */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `talA` <span class="keyword">WHERE</span> `birth` <span class="operator">&gt;</span> <span class="string">&#x27;2020-08-04 07:42:21&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `age`;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 8.没有使用索引进行排序 产生了Using filesort */</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `talA` <span class="keyword">ORDER</span> <span class="keyword">BY</span> `age` <span class="keyword">ASC</span>, `birth` <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p><code>ORDER BY</code>子句，尽量使用索引排序，避免使用<code>Using filesort</code>排序（未通过索引排序）。</p>
<p>MySQL支持两种方式的排序，<code>FileSort</code>和<code>Index</code>，<code>Index</code>的效率高，<code>FileSort</code>方式效率较低。</p>
<p><code>ORDER BY</code>满足两情况，会使用<code>Index</code>方式排序：</p>
<ul>
<li><code>ORDER BY</code>语句使用索引最左前列。</li>
<li>使用<code>WHERE</code>子句与<code>ORDER BY</code>子句条件列组合满足索引最左前列。</li>
</ul>
<p><strong>结论：尽可能在索引列上完成排序操作，遵照索引建的最佳左前缀原则。</strong></p>
<blockquote>
<p>如果不在索引列上，File Sort有两种算法：MySQL就要启动双路排序算法和单路排序算法</p>
</blockquote>
<p>1、双路排序算法：MySQL4.1之前使用双路排序，字面意思就是两次扫描磁盘，最终得到数据，读取行指针和<code>ORDER BY</code>列，対他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出。<strong>一句话，从磁盘取排序字段，在<code>buffer</code>中进行排序，再从磁盘取其他字段。</strong></p>
<p>取一批数据，要对磁盘进行两次扫描，众所周知，IO是很耗时的，所以在MySQL4.1之后，出现了改进的算法，就是单路排序算法。</p>
<p>2、单路排序算法：从磁盘读取查询需要的所有列，按照<code>ORDER BY</code>列在<code>buffer</code>対它们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO，但是它会使用更多的空间，因为它把每一行都保存在内存中了。</p>
<p>由于单路排序算法是后出的，总体而言效率好过双路排序算法。</p>
<p>但是单路排序算法有问题：如果<code>SortBuffer</code>缓冲区太小，导致从磁盘中读取所有的列不能完全保存在<code>SortBuffer</code>缓冲区中，这时候单路复用算法就会出现问题，反而性能不如双路复用算法。</p>
<p><strong>单路复用算法的优化策略：</strong></p>
<ul>
<li>增大<code>sort_buffer_size</code>参数的设置。</li>
<li>增大<code>max_length_for_sort_data</code>参数的设置。</li>
</ul>
<p><strong>提高ORDER BY排序的速度：</strong></p>
<ul>
<li><p><code>ORDER BY</code>时使用<code>SELECT *</code>是大忌，查什么字段就写什么字段，这点非常重要。在这里的影响是：</p>
<ul>
<li>当查询的字段大小总和小于<code>max_length_for_sort_data</code>而且排序字段不是<code>TEXT|BLOB</code>类型时，会使用单路排序算法，否则使用多路排序算法。</li>
<li>两种排序算法的数据都有可能超出<code>sort_buffer</code>缓冲区的容量，超出之后，会创建<code>tmp</code>临时文件进行合并排序，导致多次IO，但是单路排序算法的风险会更大一些，所以要增大<code>sort_buffer_size</code>参数的设置。</li>
</ul>
</li>
<li><p>尝试提高<code>sort_buffer_size</code>：不管使用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程的。</p>
</li>
<li><p>尝试提高<code>max_length_for_sort_data</code>：提高这个参数，会增加用单路排序算法的概率。但是如果设置的太高，数据总容量<code>sort_buffer_size</code>的概率就增大，明显症状是高的磁盘IO活动和低的处理器使用率。</p>
</li>
</ul>
<h2 id="9-3、GORUP-BY优化"><a href="#9-3、GORUP-BY优化" class="headerlink" title="9.3、GORUP BY优化"></a>9.3、GORUP BY优化</h2><ul>
<li><p><code>GROUP BY</code>实质是先排序后进行分组，遵照索引建的最佳左前缀。</p>
</li>
<li><p>当无法使用索引列时，会使用<code>Using filesort</code>进行排序，增大<code>max_length_for_sort_data</code>参数的设置和增大<code>sort_buffer_size</code>参数的设置，会提高性能。</p>
</li>
<li><p><code>WHERE</code>执行顺序高于<code>HAVING</code>，能写在<code>WHERE</code>限定条件里的就不要写在<code>HAVING</code>中了。</p>
</li>
</ul>
<h2 id="9-4、总结"><a href="#9-4、总结" class="headerlink" title="9.4、总结"></a>9.4、总结</h2><p><strong>为排序使用索引</strong></p>
<ul>
<li>MySQL两种排序方式：<code>Using filesort</code>和<code>Index</code>扫描有序索引排序。</li>
<li>MySQL能为排序与查询使用相同的索引，创建的索引既可以用于排序也可以用于查询。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 创建a b c三个字段的索引 */</span></span><br><span class="line">idx_table_a_b_c(a, b, c)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 1.ORDER BY 能使用索引最左前缀 */</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a, b;</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a, b, c;</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a <span class="keyword">DESC</span>, b <span class="keyword">DESC</span>, c <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2.如果WHERE子句中使用索引的最左前缀定义为常量，则ORDER BY能使用索引 */</span></span><br><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> b, c;</span><br><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span> <span class="keyword">AND</span> b <span class="operator">=</span> <span class="string">&#x27;Tangs&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> c;</span><br><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="string">&#x27;Ringo&#x27;</span> <span class="keyword">AND</span> b <span class="operator">&gt;</span> <span class="number">2000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> b, c;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3.不能使用索引进行排序 */</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a <span class="keyword">ASC</span>, b <span class="keyword">DESC</span>, c <span class="keyword">DESC</span>;  <span class="comment">/* 排序不一致 */</span></span><br><span class="line"><span class="keyword">WHERE</span> g <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> b, c;   <span class="comment">/* 丢失a字段索引 */</span></span><br><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> c;      <span class="comment">/* 丢失b字段索引 */</span></span><br><span class="line"><span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> a, d;   <span class="comment">/* d字段不是索引的一部分 */</span></span><br><span class="line"><span class="keyword">WHERE</span> a <span class="keyword">IN</span> (...) <span class="keyword">ORDER</span> <span class="keyword">BY</span> b, c;  <span class="comment">/* 对于排序来说，多个相等条件(a=1 or a=2)也是范围查询 */</span></span><br></pre></td></tr></table></figure>

<h1 id="10、性能分析"><a href="#10、性能分析" class="headerlink" title="10、性能分析"></a>10、性能分析</h1><h2 id="8-1-EXPLAIN简介"><a href="#8-1-EXPLAIN简介" class="headerlink" title="8.1.EXPLAIN简介"></a>8.1.EXPLAIN简介</h2><blockquote>
<p>EXPLAIN是什么？</p>
</blockquote>
<p>EXPLAIN：SQL的执行计划，使用EXPLAIN关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理SQL语句的。</p>
<blockquote>
<p>EXPLAIN怎么使用？</p>
</blockquote>
<p>语法：<code>explain</code> + <code>SQL</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> explain select * from pms_category \G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: pms_category</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 1425</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: NULL</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>EXPLAIN能干嘛？</p>
</blockquote>
<p>可以查看以下信息：</p>
<ul>
<li><code>id</code>：表的读取顺序。</li>
<li><code>select_type</code>：数据读取操作的操作类型。</li>
<li><code>possible_keys</code>：哪些索引可以使用。</li>
<li><code>key</code>：哪些索引被实际使用。</li>
<li><code>ref</code>：表之间的引用。</li>
<li><code>rows</code>：每张表有多少行被优化器查询。</li>
</ul>
<h2 id="8-2-EXPLAIN字段"><a href="#8-2-EXPLAIN字段" class="headerlink" title="8.2.EXPLAIN字段"></a>8.2.EXPLAIN字段</h2><blockquote>
<p>id</p>
</blockquote>
<p><code>id</code>：表的读取和加载顺序。</p>
<p>值有以下三种情况：</p>
<ul>
<li><code>id</code>相同，执行顺序由上至下。</li>
<li><code>id</code>不同，如果是子查询，id的序号会递增，<strong>id值越大优先级越高，越先被执行。</strong></li>
<li><code>id</code>相同不同，同时存在。<strong>永远是id大的优先级最高，id相等的时候顺序执行。</strong></li>
</ul>
<blockquote>
<p>select_type</p>
</blockquote>
<p><code>select_type</code>：数据查询的类型，主要是用于区别，普通查询、联合查询、子查询等的复杂查询。</p>
<ul>
<li><code>SIMPLE</code>：简单的<code>SELECT</code>查询，查询中不包含子查询或者<code>UNION </code>。</li>
<li><code>PRIMARY</code>：查询中如果包含任何复杂的子部分，最外层查询则被标记为<code>PRIMARY</code>。</li>
<li><code>SUBQUERY</code>：在<code>SELECT</code>或者<code>WHERE</code>子句中包含了子查询。</li>
<li><code>DERIVED</code>：在<code>FROM</code>子句中包含的子查询被标记为<code>DERIVED(衍生)</code>，MySQL会递归执行这些子查询，把结果放在临时表中。</li>
<li><code>UNION</code>：如果第二个<code>SELECT</code>出现在<code>UNION</code>之后，则被标记为<code>UNION</code>；若<code>UNION</code>包含在<code>FROM</code>子句的子查询中，外层<code>SELECT</code>将被标记为<code>DERIVED</code>。</li>
<li><code>UNION RESULT</code>：从<code>UNION</code>表获取结果的<code>SELECT</code>。</li>
</ul>
<blockquote>
<p>type</p>
</blockquote>
<p><code>type</code>：访问类型排列。</p>
<p><strong>从最好到最差依次是：</strong><code>system</code>&gt;<code>const</code>&gt;<code>eq_ref</code>&gt;<code>ref</code>&gt;<code>range</code>&gt;<code>index</code>&gt;<code>ALL</code>。除了<code>ALL</code>没有用到索引，其他级别都用到索引了。</p>
<p>一般来说，得保证查询至少达到<code>range</code>级别，最好达到<code>ref</code>。</p>
<ul>
<li><p><code>system</code>：表只有一行记录（等于系统表），这是<code>const</code>类型的特例，平时不会出现，这个也可以忽略不计。</p>
</li>
<li><p><code>const</code>：表示通过索引一次就找到了，<code>const</code>用于比较<code>primary key</code>或者<code>unique</code>索引。因为只匹配一行数据，所以很快。如将主键置于<code>where</code>列表中，MySQL就能将该查询转化为一个常量。</p>
</li>
<li><p><code>eq_ref</code>：唯一性索引扫描，读取本表中和关联表表中的每行组合成的一行，查出来只有一条记录。除 了 <code>system</code> 和<code> const</code> 类型之外, 这是最好的联接类型。</p>
</li>
<li><p><code>ref</code>：非唯一性索引扫描，返回本表和关联表某个值匹配的所有行，查出来有多条记录。</p>
</li>
<li><p><code>range</code>：只检索给定范围的行，一般就是在<code>WHERE</code>语句中出现了<code>BETWEEN</code>、<code>&lt; &gt;</code>、<code>in</code>等的查询。这种范围扫描索引比全表扫描要好，因为它只需要开始于索引树的某一点，而结束于另一点，不用扫描全部索引。</p>
</li>
<li><p><code>index</code>：<code>Full Index Scan</code>，全索引扫描，<code>index</code>和<code>ALL</code>的区别为<code>index</code>类型只遍历索引树。<strong>也就是说虽然<code>ALL</code>和<code>index</code>都是读全表，但是<code>index</code>是从索引中读的，<code>ALL</code>是从磁盘中读取的。</strong></p>
</li>
<li><p><code>ALL</code>：<code>Full Table Scan</code>，没有用到索引，全表扫描。</p>
</li>
</ul>
<blockquote>
<p>possible_keys 和 key</p>
</blockquote>
<p><code>possible_keys</code>：显示可能应用在这张表中的索引，一个或者多个。查询涉及到的字段上若存在索引，则该索引将被列出，<strong>但不一定被查询实际使用。</strong></p>
<p><code>key</code>：实际使用的索引。如果为<code>NULL</code>，则没有使用索引。查询中如果使用了覆盖索引，则该索引仅仅出现在<code>key</code>列表中。</p>
<blockquote>
<p>key_len</p>
</blockquote>
<p><code>key_len</code>：表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。<code>key_len</code>显示的值为索引字段的最大可能长度，并非实际使用长度，即<code>key_len</code>是根据表定义计算而得，不是通过表内检索出的。在不损失精度的情况下，长度越短越好。</p>
<p><code>key_len</code>计算规则：<strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34930488/article/details/102931490">https://blog.csdn.net/qq_34930488/article/details/102931490</a></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> desc pms_category;</span></span><br><span class="line">+---------------+------------+------+-----+---------+----------------+</span><br><span class="line">| Field         | Type       | Null | Key | Default | Extra          |</span><br><span class="line">+---------------+------------+------+-----+---------+----------------+</span><br><span class="line">| cat_id        | bigint(20) | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name          | char(50)   | YES  |     | NULL    |                |</span><br><span class="line">| parent_cid    | bigint(20) | YES  |     | NULL    |                |</span><br><span class="line">| cat_level     | int(11)    | YES  |     | NULL    |                |</span><br><span class="line">| show_status   | tinyint(4) | YES  |     | NULL    |                |</span><br><span class="line">| sort          | int(11)    | YES  |     | NULL    |                |</span><br><span class="line">| icon          | char(255)  | YES  |     | NULL    |                |</span><br><span class="line">| product_unit  | char(50)   | YES  |     | NULL    |                |</span><br><span class="line">| product_count | int(11)    | YES  |     | NULL    |                |</span><br><span class="line">+---------------+------------+------+-----+---------+----------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> explain select cat_id from pms_category <span class="built_in">where</span> cat_id between 10 and 20 \G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: pms_category</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: range</span><br><span class="line">possible_keys: PRIMARY</span><br><span class="line">          key: PRIMARY  # 用到了主键索引，通过查看表结构知道，cat_id是bigint类型，占用8个字节</span><br><span class="line">      key_len: 8        # 这里只用到了cat_id主键索引，所以长度就是8！</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 11</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: Using where; Using index</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ref</p>
</blockquote>
<p><code>ref</code>：显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值。</p>
<blockquote>
<p>rows</p>
</blockquote>
<p><code>rows</code>：根据表统计信息及索引选用情况，大致估算出找到所需的记录需要读取的行数。</p>
<blockquote>
<p>Extra</p>
</blockquote>
<p><code>Extra</code>：包含不适合在其他列中显示但十分重要的额外信息。</p>
<ul>
<li><code>Using filesort</code>：说明MySQL会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。<strong>MySQL中无法利用索引完成的排序操作成为”文件内排序”。</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 排序没有使用索引</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> explain select name from pms_category <span class="built_in">where</span> name=<span class="string">&#x27;Tangs&#x27;</span> order by cat_level \G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: pms_category</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: ref</span><br><span class="line">possible_keys: idx_name_parentCid_catLevel</span><br><span class="line">          key: idx_name_parentCid_catLevel</span><br><span class="line">      key_len: 201</span><br><span class="line">          ref: const</span><br><span class="line">         rows: 1</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: Using where; Using index; Using filesort</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 排序使用到了索引</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> explain select name from pms_category <span class="built_in">where</span> name=<span class="string">&#x27;Tangs&#x27;</span> order by parent_cid,cat_level\G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: pms_category</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: ref</span><br><span class="line">possible_keys: idx_name_parentCid_catLevel</span><br><span class="line">          key: idx_name_parentCid_catLevel</span><br><span class="line">      key_len: 201</span><br><span class="line">          ref: const</span><br><span class="line">         rows: 1</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: Using where; Using index</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>Using temporary</code>：使用了临时表保存中间结果，MySQL在対查询结果排序时使用了临时表。常见于排序<code>order by</code>和分组查询<code>group by</code>。<strong>临时表対系统性能损耗很大。</strong></p>
</li>
<li><p><code>Using index</code>：表示相应的<code>SELECT</code>操作中使用了覆盖索引，避免访问了表的数据行，效率不错！如果同时出现<code>Using where</code>，表示索引被用来执行索引键值的查找；如果没有同时出现<code>Using where</code>，表明索引用来读取数据而非执行查找动作。</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 覆盖索引</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 就是select的数据列只用从索引中就能够取得，不必从数据表中读取，换句话说查询列要被所使用的索引覆盖。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意：如果要使用覆盖索引，一定不能写SELECT *，要写出具体的字段。</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> explain select cat_id from pms_category \G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: pms_category</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: index</span><br><span class="line">possible_keys: NULL       </span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 8</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 1425</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: Using index   # select的数据列只用从索引中就能够取得，不必从数据表中读取   </span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Using where</code>：表明使用了<code>WHERE</code>过滤。</li>
<li><code>Using join buffer</code>：使用了连接缓存。</li>
<li><code>impossible where</code>：<code>WHERE</code>子句的值总是false，不能用来获取任何元组。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> explain select name from pms_category <span class="built_in">where</span> name = <span class="string">&#x27;zs&#x27;</span> and name = <span class="string">&#x27;ls&#x27;</span>\G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: NULL</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: NULL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: NULL</span><br><span class="line">     filtered: NULL</span><br><span class="line">        Extra: Impossible WHERE   # 不可能字段同时查到两个名字</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>



<h1 id="11、主从复制"><a href="#11、主从复制" class="headerlink" title="11、主从复制"></a>11、主从复制</h1><h2 id="11-1、复制基本原理"><a href="#11-1、复制基本原理" class="headerlink" title="11.1、复制基本原理"></a>11.1、复制基本原理</h2><p><img src="/img/MySQL/5.jpg"></p>
<p>MySQL复制过程分为三步：记录到日志 —–&gt;  拷贝到中继日志  —-&gt;   操作日志</p>
<ul>
<li>Master将改变记录到二进制日志(Binary Log)。这些记录过程叫做二进制日志事件，<code>Binary Log Events</code>；</li>
<li>Slave将Master的<code>Binary Log Events</code>拷贝到它的中继日志(Replay  Log);</li>
<li>Slave重做中继日志中的事件，将改变应用到自己的数据库中。MySQL复制是异步且串行化的。</li>
</ul>
<h2 id="10-2、复制基本原则"><a href="#10-2、复制基本原则" class="headerlink" title="10.2、复制基本原则"></a>10.2、复制基本原则</h2><ul>
<li>每个Slave只有一个Master。</li>
<li>每个Slave只能有一个唯一的服务器ID。</li>
<li>每个Master可以有多个Salve。</li>
</ul>
<h2 id="10-3、一主一从配置"><a href="#10-3、一主一从配置" class="headerlink" title="10.3、一主一从配置"></a>10.3、一主一从配置</h2><blockquote>
<p>1、基本要求：Master和Slave的MySQL服务器版本一致且后台以服务运行。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建mysql-slave1实例</span></span><br><span class="line">docker run -p 3307:3306 --name mysql-slave1 \</span><br><span class="line">-v /root/mysql-slave1/log:/var/log/mysql \</span><br><span class="line">-v /root/mysql-slave1/data:/var/lib/mysql \</span><br><span class="line">-v /root/mysql-slave1/conf:/etc/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=333 \</span><br><span class="line">-d mysql:5.7</span><br></pre></td></tr></table></figure>

<blockquote>
<p>2、主从配置都是配在[mysqld]节点下，都是小写</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Master配置</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1 # 必须</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin # 必须</span><br><span class="line">read-only=0</span><br><span class="line">binlog-ignore-db=mysql</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Slave配置</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2 # 必须</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin</span><br></pre></td></tr></table></figure>

<blockquote>
<p>3、Master配置</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、GRANT REPLICATION SLAVE ON *.* TO <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;从机IP地址&#x27;</span> IDENTIFIED BY <span class="string">&#x27;password&#x27;</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION SLAVE ON *.* TO <span class="string">&#x27;zhangsan&#x27;</span>@<span class="string">&#x27;172.18.0.3&#x27;</span> IDENTIFIED BY <span class="string">&#x27;123456&#x27;</span>;</span></span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、刷新命令</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3、记录下File和Position</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 每次配从机的时候都要SHOW MASTER STATUS;查看最新的File和Position</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS;</span></span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000001 |      602 |              | mysql            |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>4、Slave从机配置</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=&#x27;172.18.0.4&#x27;,</span><br><span class="line">MASTER_USER=&#x27;zhangsan&#x27;,</span><br><span class="line">MASTER_PASSWORD=&#x27;123456&#x27;,</span><br><span class="line">MASTER_LOG_FILE=&#x27;mysql-bin.File的编号&#x27;,</span><br><span class="line">MASTER_LOG_POS=Position的最新值;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、使用用户名密码登录进Master</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;172.18.0.4&#x27;</span>,</span></span><br><span class="line">    -&gt; MASTER_USER=&#x27;zhangsan&#x27;,</span><br><span class="line">    -&gt; MASTER_PASSWORD=&#x27;123456&#x27;,</span><br><span class="line">    -&gt; MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;,</span><br><span class="line">    -&gt; MASTER_LOG_POS=602;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、开启Slave从机的复制</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START SLAVE;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3、查看Slave状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Slave_IO_Running 和 Slave_SQL_Running 必须同时为Yes 说明主从复制配置成功！</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event # Slave待命状态</span><br><span class="line">                  Master_Host: 172.18.0.4</span><br><span class="line">                  Master_User: zhangsan</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 602</span><br><span class="line">               Relay_Log_File: b030ad25d5fe-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes  </span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 602</span><br><span class="line">              Relay_Log_Space: 534</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: bd047557-b20c-11ea-9961-0242ac120002</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>5、测试主从复制</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Master创建数据库</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create database test_replication;</span></span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Slave查询数据库</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| test_replication   |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>6、停止主从复制功能</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、停止Slave</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> STOP SLAVE;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、重新配置主从</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MASTER_LOG_FILE 和 MASTER_LOG_POS一定要根据最新的数据来配</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;172.18.0.4&#x27;</span>,</span></span><br><span class="line">    -&gt; MASTER_USER=&#x27;zhangsan&#x27;,</span><br><span class="line">    -&gt; MASTER_PASSWORD=&#x27;123456&#x27;,</span><br><span class="line">    -&gt; MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;,</span><br><span class="line">    -&gt; MASTER_LOG_POS=797;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.01 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START SLAVE;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.18.0.4</span><br><span class="line">                  Master_User: zhangsan</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 797</span><br><span class="line">               Relay_Log_File: b030ad25d5fe-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 797</span><br><span class="line">              Relay_Log_Space: 534</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: bd047557-b20c-11ea-9961-0242ac120002</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>





<h1 id="12、常见面试题"><a href="#12、常见面试题" class="headerlink" title="12、常见面试题"></a>12、常见面试题</h1><blockquote>
<p>SQL查询缓慢</p>
</blockquote>
<p>总结（大纲）：</p>
<ol>
<li>开启日志，根据时间，抓取捕获。</li>
<li>explain + 慢SQL分析。</li>
<li>show Profile查询SQL在MySQL数据库中的执行细节和生命周期情况。</li>
<li>MySQL数据库服务器的参数调优。</li>
</ol>
<blockquote>
<p>大表优化</p>
</blockquote>
<p>当MySQL单表记录数过大时，数据库的CRUD性能会明显下降，⼀些常见的优化措施如下</p>
<ol>
<li>限定范围，如删除一个月之前的记录</li>
<li>读写分离：主库负责写，从库负责读</li>
<li>垂直分区：把一张表拆分成多张表，可以简化结构，但是会带来数据冗余，引起Join操作；而且事务更加复杂。</li>
<li>水平分区：表的数据还是在同⼀台机器上，其实对于提升MySQL并发能⼒没有什么意义，所以<strong>水平拆分最好分库</strong> 。而且会带来逻辑、部署、运维的各种复杂度，如果实在要分片，尽量选择客户端分片架构，这样可以减少⼀次和中间件的网络 IO水平拆分难以解决分片事务，跨节点Join性能差，逻辑复杂。<ul>
<li><strong>客户端代理：</strong> 分片逻辑在应用端，封装在jar包中，通过修改或者封装JDBC层来实现。当当网的 <strong>Sharding-JDBC</strong> 、阿⾥的TDDL是两种比较常用的实现。</li>
<li><strong>中间件代理：</strong> 在应用和数据中间加了⼀个代理层。分片逻辑统⼀维护在中间件服务中。我们现在谈的 Mycat 、360的Atlas、网易的DDB等等都是这种架构的实现。</li>
</ul>
</li>
</ol>
<blockquote>
<p>池化技术</p>
</blockquote>
<p>有些对象创建的代价比较大，比如线程、tcp连接、数据库连接等对象。对于这些创建耗时较长，或者资源占用较大(占据操作系统资源，比如说线程，网络连接等)的对象；同时这些资源又是经常使用的，为了避免频繁的创建、销毁这些对象，就使用池化技术，把这些资源放入池中，实现资源的重复使用。</p>
<p><strong>总结：</strong>获取资源直接从池中获取，实现复用，避免每次都需要重写创建对象。</p>
<blockquote>
<p>分库分表之后,id主键如何处理</p>
</blockquote>
<p>分成多个表之后，需要⼀个全局唯⼀的id 来⽀持。</p>
<ul>
<li>UUID：不适合作为主键，因为太长了，并且无序不可读，查询效率低。</li>
<li>数据库自增ID : 两台数据库分别设置不同步长，⽣成不重复ID的策略来实现高可用。这种方式生成的 id 有序，但是需要独立部署数据库实例，成本高，还会有性能瓶颈。</li>
<li>利用 redis 生成ID：性能高，不依赖数据库，但是加入 redis 组件，系统更复杂，可用性降低。</li>
<li>Twitter的snowflake（雪花）算法：</li>
<li>美团的Leaf分布式ID生成系统：</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Bug</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2021/06/20/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/">http://example.com/2021/06/20/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Notes</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93/">MySQL数据库</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/06/18/JavaSE/%E5%B8%B8%E7%94%A8API/"><img class="prev-cover" src="/img/cover/22.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">常用API和知识点</div></div></a></div><div class="next-post pull-right"><a href="/2021/06/20/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/"><img class="next-cover" src="/img/cover/18.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">1、数据库基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">1.1、数据库基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E7%B1%BB"><span class="toc-text">1.2、数据库分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3%E3%80%81%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">1.3、数据模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-text">1.4、数据库体系结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5%E3%80%81SQL%E8%AF%AD%E8%A8%80%E7%BB%84%E6%88%90"><span class="toc-text">1.5、SQL语言组成</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81MySQL%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-text">2、MySQL的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1%E3%80%81%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85"><span class="toc-text">2.1、环境安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2%E3%80%81%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E9%9B%86"><span class="toc-text">2.2、修改字符集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2.3、配置文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81MySQL%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">3、MySQL的基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1%E3%80%81MySQL%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84"><span class="toc-text">3.1、MySQL逻辑架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2%E3%80%81MySQL%E7%9A%84%E5%BC%95%E6%93%8E"><span class="toc-text">3.2、MySQL的引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="toc-text">3.3、数据库的字段类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4%E3%80%81MySQL%E5%AD%97%E7%AC%A6%E9%9B%86%E6%A0%A1%E9%AA%8C"><span class="toc-text">3.4、MySQL字符集校验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%AD%97%E7%AC%A6%E9%9B%86"><span class="toc-text">1、字符集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8MYSQL%E5%AD%97%E7%AC%A6%E9%9B%86"><span class="toc-text">2、正确使用MYSQL字符集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81MySQL%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E5%AD%97%E7%AC%A6%E9%9B%86"><span class="toc-text">3、MySQL客户端与字符集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="toc-text">4、常用操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5%E3%80%81MySQL%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-text">3.5、MySQL常用函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81MySQL%E5%B8%B8%E9%87%8F"><span class="toc-text">1、MySQL常量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-text">2、常用函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="toc-text">3、聚合函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81MD5%E5%8A%A0%E5%AF%86"><span class="toc-text">4、MD5加密</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6%E3%80%81SQL%E6%80%A7%E8%83%BD%E4%B8%8B%E9%99%8D%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-text">3.6、SQL性能下降的原因</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81DDL%E7%BB%93%E6%9E%84%E5%8C%96%E8%AF%AD%E5%8F%A5"><span class="toc-text">4、DDL结构化语句</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1%E3%80%81DDL%E4%B9%8B%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">4.1、DDL之创建数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2%E3%80%81DDL%E4%B9%8B%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-text">4.2、DDL之创建表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3%E3%80%81DDL%E4%B9%8B%E8%A1%A8%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="toc-text">4.3、DDL之表的修改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4%E3%80%81%E6%95%B0%E6%8D%AE%E7%BA%A6%E6%9D%9F"><span class="toc-text">4.4、数据约束</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5%E3%80%81%E7%B4%A2%E5%BC%95%E5%85%A5%E9%97%A8"><span class="toc-text">4.5、索引入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%B4%A2%E5%BC%95%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-text">1、索引的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BC%98%E5%8A%A3"><span class="toc-text">2、索引的优劣</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-text">3、索引的分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E7%BA%A6%E6%9D%9F%E5%92%8C%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">4、约束和索引的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%88%9B%E5%BB%BA%E3%80%81%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-text">5、创建、删除索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-text">6、索引使用建议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E3%80%81DML%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-text">5、DML增删改查</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1%E3%80%81DML%E8%AF%AD%E8%A8%80%E4%B9%8B%E5%A2%9E%E5%88%A0%E6%94%B9"><span class="toc-text">5.1、DML语言之增删改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2%E3%80%81DML%E8%AF%AD%E8%A8%80%E4%B9%8B%E6%9F%A5"><span class="toc-text">5.2、DML语言之查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3%E3%80%81%E4%B8%83%E7%A7%8DJOIN%E7%90%86%E8%AE%BA%E6%80%BB%E7%BB%93"><span class="toc-text">4.3、七种JOIN理论总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%E3%80%81DCL%E8%AF%AD%E5%8F%A5"><span class="toc-text">6、DCL语句</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1%E3%80%81DCL%EF%BC%9A%E4%BA%8B%E5%8A%A1"><span class="toc-text">6.1、DCL：事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%BA%8B%E5%8A%A1%E5%8E%9F%E5%88%99"><span class="toc-text">1、事务原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%89%8B%E5%8A%A8%E6%89%A7%E8%A1%8C%E4%BA%8B%E5%8A%A1"><span class="toc-text">2、手动执行事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="toc-text">3、并发问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81MySQL%E7%9A%84%E8%A1%A8%E7%BA%A7%E9%94%81%EF%BC%88%E5%81%8F%E8%AF%BB%EF%BC%89"><span class="toc-text">4、MySQL的表级锁（偏读）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81MySQL%E7%9A%84%E8%A1%8C%E7%BA%A7%E9%94%81%EF%BC%88%E5%81%8F%E5%86%99%EF%BC%89"><span class="toc-text">5、MySQL的行级锁（偏写）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E9%97%B4%E9%9A%99%E9%94%81"><span class="toc-text">6、间隙锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2%E3%80%81DCL%EF%BC%9A%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-text">6.2、DCL：权限管理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%A4%87%E4%BB%BD"><span class="toc-text">7、数据库的备份</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8%E3%80%81MySQL%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">8、MySQL索引失效</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1%E3%80%81%E6%9C%80%E4%BD%B3%E5%B7%A6%E5%89%8D%E7%BC%80%E6%B3%95%E5%88%99"><span class="toc-text">8.1、最佳左前缀法则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2%E3%80%81%E7%B4%A2%E5%BC%95%E5%88%97%E4%B8%8A%E4%B8%8D%E8%AE%A1%E7%AE%97"><span class="toc-text">8.2、索引列上不计算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3%E3%80%81%E8%8C%83%E5%9B%B4%E4%B9%8B%E5%90%8E%E5%85%A8%E5%A4%B1%E6%95%88"><span class="toc-text">8.3、范围之后全失效</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4%E3%80%81%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95%E5%B0%BD%E9%87%8F%E7%94%A8"><span class="toc-text">8.4、覆盖索引尽量用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-5%E3%80%81%E4%B8%8D%E7%AD%89%E6%9C%89%E6%97%B6%E4%BC%9A%E5%A4%B1%E6%95%88"><span class="toc-text">8.5、不等有时会失效</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-6%E3%80%81like%E7%99%BE%E5%88%86%E5%8A%A0%E5%8F%B3%E8%BE%B9"><span class="toc-text">8.6、like百分加右边</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-7%E3%80%81%E5%AD%97%E7%AC%A6%E8%A6%81%E5%8A%A0%E5%8D%95%E5%BC%95%E5%8F%B7"><span class="toc-text">8.7、字符要加单引号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-8%E3%80%81%E7%B4%A2%E5%BC%95%E7%9B%B8%E5%85%B3%E9%A2%98%E7%9B%AE"><span class="toc-text">8.8、索引相关题目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-9%E3%80%81%E9%9D%A2%E8%AF%95%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">8.9、面试题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-10%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">8.10、总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9%E3%80%81MySQL%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-text">9、MySQL查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1%E3%80%81%E5%B0%8F%E8%A1%A8%E9%A9%B1%E5%8A%A8%E5%A4%A7%E8%A1%A8"><span class="toc-text">9.1、小表驱动大表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2%E3%80%81ORDER-BY%E4%BC%98%E5%8C%96"><span class="toc-text">9.2、ORDER BY优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3%E3%80%81GORUP-BY%E4%BC%98%E5%8C%96"><span class="toc-text">9.3、GORUP BY优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">9.4、总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10%E3%80%81%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-text">10、性能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-EXPLAIN%E7%AE%80%E4%BB%8B"><span class="toc-text">8.1.EXPLAIN简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-EXPLAIN%E5%AD%97%E6%AE%B5"><span class="toc-text">8.2.EXPLAIN字段</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11%E3%80%81%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">11、主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1%E3%80%81%E5%A4%8D%E5%88%B6%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-text">11.1、复制基本原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2%E3%80%81%E5%A4%8D%E5%88%B6%E5%9F%BA%E6%9C%AC%E5%8E%9F%E5%88%99"><span class="toc-text">10.2、复制基本原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3%E3%80%81%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E%E9%85%8D%E7%BD%AE"><span class="toc-text">10.3、一主一从配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12%E3%80%81%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-text">12、常见面试题</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 By Bug</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>